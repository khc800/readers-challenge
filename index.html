<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تحدي القراء</title>

  <!-- Favicon / tab icon -->
  <link rel="icon" type="image/svg+xml" href="logo2.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="mask-icon" href="logo.svg" color="#ff8f00">
  <meta name="theme-color" content="#212e3e">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    input[list]{ width: 100%; }

    /* white date icon */
    input[type="date"]{ color-scheme: dark; }
    input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1) brightness(1.8); opacity:1; }
    .date-wrap{ position:relative; display:inline-block; }
    .date-wrap input[type="date"]{ padding-inline-end:2.2rem; }
    .date-wrap input[type="date"]::-webkit-calendar-picker-indicator{ opacity:0; }
    .date-wrap .cal-ic{
      position:absolute; inset-inline-end:.6rem; inset-block-start:50%; transform:translateY(-50%);
      width:18px; height:18px; pointer-events:none;
      background:no-repeat center/contain url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">\
      <path d="M7 2h2v2h6V2h2v2h3v18H4V4h3V2zm12 6H5v12h14V8zM7 10h2v2H7v-2zm4 0h2v2h-2v-2zm4 0h2v2h-2v-2zM7 14h2v2H7v-2zm4 0h2v2h-2v-2z"/></svg>');
    }

    :root{
      --brand-dark:#212e3e; --brand-accent:#ff8f00; --brand-accent-2:#feaf00;
      --ink:#ffffff; --ink-dim:#e9eef7; --ink-muted:#b9c3d6;
      --card:#263347; --card-2:#2f3e56; --ring:#3e4f6a; --ok:#2ecc71; --warn:#ffb31a;
      --bg1:#131c29; --bg2:#1c2838;
      --chip:#33445f;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:'Almarai', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2) 60%,var(--bg1)); color:var(--ink); }
    select, input, button{ border-radius:12px; border:1px solid var(--ring); background:var(--card);
      color:var(--ink); padding:10px 12px; outline:none; font-family:inherit; }
    button{ border-color:transparent; background:linear-gradient(180deg,var(--brand-accent),var(--brand-accent-2));
      color:#111; font-weight:800; cursor:pointer; }
    #timerDisplay, .kpi .v, table td{ font-variant-numeric: tabular-nums; }

    header{ max-width:1100px; margin:24px auto 0; padding:0 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header .brand{ display:flex; align-items:center; gap:12px; font-weight:800; }
    header img.logo{ height:36px; width:auto; display:block; }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .wrap{ max-width:1100px; margin:16px auto 40px; padding:0 16px; }
    .tabs{ display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
    .tab{ padding:10px 16px; background:var(--card); border:1px solid var(--ring); border-radius:12px; cursor:pointer; user-select:none; }
    .tab.active{ background:var(--card-2); border-color:var(--brand-accent-2); box-shadow:0 0 0 2px rgba(255,143,0,.25) inset; }
    .card{ background:rgba(33,46,62,.65); backdrop-filter:blur(6px); border:1px solid var(--ring); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .row{ display:grid; grid-template-columns:repeat(4,1fr); gap:16px; }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
    .row-2{ display:grid; grid-template-columns:repeat(2,1fr); gap:16px; align-items:start; }
    @media (max-width:980px){ .row{ grid-template-columns:repeat(2,1fr); } .row-2{ grid-template-columns:1fr; } }
    @media (max-width:640px){ .row, .row-3{ grid-template-columns:1fr; } header{ flex-direction:column; align-items:flex-start; gap:8px; } }
    label{ display:block; font-size:14px; color:var(--ink-dim); margin-bottom:6px; }
    .muted{ color:var(--ink-muted); font-size:13px; }
    .spacer{ height:16px; }
    .hidden{ display:none; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid var(--ring); font-size:12px; }
    .kpi{ text-align:center; background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px; }
    .kpi .v{ font-size:28px; font-weight:800; color:var(--warn); }
    footer{ text-align:center; margin-top:20px; color:var(--ink-muted); font-size:12px; }

    /* HH:MM:SS + Timer */
    .timegrid{ display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:8px; }
    .timegrid input{ width:100%; min-width:0; text-align:center; direction:ltr; }
    .timegrid input::-webkit-outer-spin-button,
    .timegrid input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .timegrid input[type="number"]{ -moz-appearance:textfield; }
    .timer{ display:flex; flex-direction:column; gap:10px; margin-top:10px; align-items:center; }
    #timerDisplay{ text-align:center; direction:ltr; font-size:32px; font-weight:800; letter-spacing:1.5px;
      padding:10px 12px; border:1px solid var(--ring); background:var(--card); border-radius:12px; min-width:220px; }
    .timerOneBtn{ --size:60px; width:var(--size); height:var(--size); border-radius:999px; display:grid; place-items:center;
      border:1px solid var(--ring); background:linear-gradient(180deg,#ffd166,#ffb200); box-shadow:0 2px 8px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06); }
    .timerOneBtn svg{ width:26px; height:26px; fill:#111; }
    .timerHint{ font-size:12px; color:var(--ink-muted); }
    .timerOneBtn.hold{ filter:grayscale(.2) brightness(.95); }

    /* Badges */
    .badges{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:14px; margin-top:6px; }
    @media (max-width:900px){ .badges{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    @media (max-width:560px){ .badges{ grid-template-columns:1fr; } }
    .badge{ display:flex; gap:12px; align-items:center; background:var(--card); border:1px solid var(--ring); border-radius:14px; padding:12px; }
    .badge .ic{ width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
      background:linear-gradient(180deg,#ffd166,#ffb200); color:#111; font-size:22px; box-shadow:inset 0 1px 0 rgba(255,255,255,.35); }
    .badge .txt .title{ font-weight:800; color:var(--ink-dim); }
    .badge .txt .name{ font-weight:800; margin-top:2px; }
    .badge small{ color:var(--ink-muted); display:block; margin-top:2px; }
    .streak-strip{ display:flex; gap:2px; margin-top:8px; }
    .streak-strip span{ width:8px; height:10px; border-radius:2px; background:#3a4a62; }
    .streak-strip span.on{ background:var(--ok); }

    /* Segmentation visualization */
    .seg-grid{ display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:12px; margin-top:8px; }
    @media (max-width:1100px){ .seg-grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    @media (max-width:700px){ .seg-grid{ grid-template-columns:repeat(1,minmax(0,1fr)); } }
    .seg-card{ background:var(--card); border:1px solid var(--ring); border-radius:12px; padding:12px; }
    .seg-head{ font-weight:700; color:var(--ink-dim); margin-bottom:8px; display:flex; gap:8px; align-items:baseline; }
    .seg-head small{ color:var(--ink-muted); font-weight:400; }
    .seg-names{ display:flex; flex-wrap:wrap; gap:6px; }
    .chip{ display:inline-block; padding:4px 8px; border:1px solid var(--ring); border-radius:999px; background:var(--chip); font-size:12px; cursor:pointer; }
    .chip:hover{ border-color:var(--brand-accent-2); }

    table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    thead th{ text-align:right; color:var(--ink-dim); font-weight:700; }
    tbody tr{ background:var(--card); border:1px solid var(--ring); }
    tbody td{ padding:8px 10px; }

    /* Reader Calendar */
    .cal-wrap{ margin-top:12px; }
    .cal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; padding:12px; border:1px solid var(--ring); border-radius:12px; }
    .cal-grid .dow{ text-align:center; color:var(--ink-dim); font-weight:700; }
    .cal-cell{ height:58px; border-radius:10px; display:flex; align-items:flex-start; justify-content:center; padding-top:6px; position:relative; background:transparent; border:1px solid transparent; }
    .cal-cell.has{ border-color:var(--ring); background:rgba(255,255,255,.03); }
    .cal-cell .d{ opacity:.95; }
    .cal-cell .dot{ position:absolute; bottom:8px; width:8px; height:8px; border-radius:50%; background:var(--ok); }
    body.rtl{ direction: rtl; } body.rtl .row, body.rtl .row-3{ direction: rtl; }
  </style>
</head>
<body class="rtl">
  <header>
    <div class="brand">
      <img class="logo" id="logo" alt="Logo" />
      <div id="appTitle">تحدي القراء</div>
    </div>
    <div class="controls">
      <select id="langSel" title="اللغة">
        <option value="ar" selected>العربية</option>
        <option value="en">English</option>
      </select>
      <select id="weekTypeSel" title="نمط الأسبوع">
        <option value="rolling">٧ أيام متحركة</option>
        <option value="calendar">أسبوع تقويمي (السبت–الجمعة)</option>
      </select>
    </div>
  </header>

  <div class="wrap">
    <div class="tabs" role="tablist" aria-label="Pages">
      <div class="tab active" data-tab="log" role="tab" aria-selected="true" tabindex="0" id="tab-log">تسجيل القراءة</div>
      <div class="tab" data-tab="stats" role="tab" aria-selected="false" tabindex="0" id="tab-stats">لوحة الإحصائيات</div>
      <div class="tab" data-tab="reader" role="tab" aria-selected="false" tabindex="0" id="tab-reader">سجل القارئ</div>
      <div class="tab" data-tab="discipline" role="tab" aria-selected="false" tabindex="0" id="tab-discipline">المطرودون/الإنذارات</div>
    </div>

    <!-- Log Form -->
    <div id="panel-log" class="card" role="tabpanel" aria-labelledby="tab-log">
      <h2 id="logTitle" style="margin-top:0">إضافة جلسة قراءة</h2>
      <div class="row">
        <div>
          <label for="name" id="lblReader">القارئ</label>
          <input id="name" list="namesList" autocomplete="off" placeholder="اسمك…" />
          <datalist id="namesList"></datalist>
          <div class="muted" id="nameHint">لم تجد اسمك؟ تواصل مع المجلس الأعلى</div>
        </div>

        <div>
          <label id="lblDuration">المدة (ث:د:س)</label>
          <div class="timegrid">
            <input id="durS" type="number" min="0" max="59" step="1" placeholder="ث" inputmode="numeric" />
            <input id="durM" type="number" min="0" max="59" step="1" placeholder="د" inputmode="numeric" />
            <input id="durH" type="number" min="0" step="1" placeholder="س" inputmode="numeric" />
          </div>
          <div class="timer">
            <div id="timerDisplay">00:00:00</div>
            <button id="btnOne" class="timerOneBtn" aria-label="بدء/إيقاف مؤقت" title="اضغط للتشغيل/الإيقاف المؤقّت (ضغط مطوّل لإعادة الضبط)">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path id="oneIcon" d="M8 5v14l11-7z"/></svg>
            </button>
            <div class="timerHint">ضغط مطوّل لإعادة الضبط</div>
          </div>
          <div class="muted" id="durationHint">أدخل الساعات والدقائق والثواني</div>
        </div>

        <div>
          <label for="date" id="lblDate">التاريخ</label>
          <div class="date-wrap">
            <input id="date" type="date" />
            <span class="cal-ic" aria-hidden="true"></span>
          </div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="submitBtn">حفظ</button>
          <span class="muted" id="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div id="panel-stats" class="card hidden" role="tabpanel" aria-labelledby="tab-stats">
      <h2 id="dashTitle" style="margin-top:0">لوحة الإحصائيات</h2>

      <!-- القسم الثابت الخاص بالأسبوع (أعلى الصفحة) -->
      <div class="pill">جوائز الأسبوع</div>
      <div id="badges" class="badges"></div>

      <div class="spacer"></div>

      <div class="row-2">
        <div>
          <div class="pill" id="pillDOW">قوة أيام الأسبوع (متوسط آخر ١٢ أسبوع)</div>
          <canvas id="chartDOW" height="120"></canvas>
        </div>
        <div>
          <div class="pill" id="pillStreaks">سلاسل الأيام المتتالية (≥ دقيقة يومياً) · <span class="muted">يُحسب لآخر 180 يومًا</span></div>
          <table id="tblStreaks">
            <thead><tr><th id="thReader">القارئ</th><th id="thCurrent">الحالية</th><th id="thLongest">الأطول</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="spacer"></div>

      <!-- القسم المتغيّر مع الفترة -->
      <div class="pill">مؤشرات الفترة المختارة</div>
      <div class="row">
        <div>
          <label for="statsDate" id="lblRefDate">تاريخ المرجع</label>
          <div class="date-wrap">
            <input id="statsDate" type="date" />
            <span class="cal-ic" aria-hidden="true"></span>
          </div>
        </div>
        <div>
          <label for="rangeSel" id="lblRange">المدى</label>
          <select id="rangeSel">
            <option value="day">اليوم</option>
            <option value="week" selected>الأسبوع</option>
            <option value="month">الشهر</option>
            <option value="all">كل الوقت</option>
          </select>
        </div>
        <div>
          <label for="topNSel" id="lblTopN" class="muted" style="display:block;">أفضل N</label>
          <select id="topNSel">
            <option>10</option><option selected>20</option><option>50</option><option>100</option><option>All</option>
          </select>
        </div>
        <div>
          <label for="segSel" id="lblSeg" class="muted" style="display:block;">التصنيف</label>
          <select id="segSel">
            <option value="all" selected>الكل</option>
            <option value="steady">مستقرون</option>
            <option value="sprinter">اندفاعيون</option>
            <option value="weekend">تركيز نهاية الأسبوع</option>
            <option value="mixed">متنوع</option>
            <option value="inactive">غير نشط</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="refreshBtn">تحديث</button>
          <span class="muted" id="rangeHint">اليوم = نفس التاريخ · الأسبوع = ٧ أيام متحركة أو أسبوع تقويمي (السبت–الجمعة) · الشهر = شهر تقويمي</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row-3" id="kpiRow">
        <div class="kpi"><div class="v" id="kpi-total">–</div><div class="muted" id="kpiTotalLabel">إجمالي الدقائق</div></div>
        <div class="kpi"><div class="v" id="kpi-avg">–</div><div class="muted" id="kpiAvgLabel">متوسط لكل قارئ</div></div>
        <div class="kpi"><div class="v" id="kpi-count">–</div><div class="muted" id="kpiCountLabel">عدد القرّاء النشطين</div></div>
      </div>

      <div class="spacer"></div>

      <div class="pill" id="pillByReader">حسب القارئ</div>
      <canvas id="chartMain" height="160"></canvas>

      <div class="spacer"></div>

      <div>
        <div class="pill" id="pillSegments">تصنيفات القرّاء (آخر ١٢ أسبوع)</div>
        <div id="segCounts" class="muted">—</div>
        <div id="segGrid" class="seg-grid"></div>
      </div>
    </div>

    <!-- Reader History -->
    <div id="panel-reader" class="card hidden" role="tabpanel" aria-labelledby="tab-reader">
      <h2 id="readerTitle" style="margin-top:0">سجل القارئ</h2>
      <div class="row">
        <div>
          <label for="readerSel" id="lblReaderSel">القارئ</label>
          <input id="readerSel" list="readerList" autocomplete="off" placeholder="ابحث عن قارئ…" />
          <datalist id="readerList"></datalist>
        </div>
        <div>
          <label for="readerMonth">الشهر</label>
          <input id="readerMonth" type="month" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="readerBtn">عرض</button>
          <span class="muted" id="readerHint">يعرض أيام القراءة فقط في الشهر المختار + منحنى الدقائق</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="pill" id="pillHistory">الدقائق اليومية</div>
      <canvas id="chartHistory" height="160"></canvas>

      <div class="spacer"></div>

      <div class="cal-wrap">
        <div class="cal-head">
          <div class="pill">تقويم الشهر المختار</div>
          <div class="muted">النقاط الخضراء = يوم فيه قراءة</div>
        </div>
        <div id="readerCal" class="cal-grid"></div>
      </div>
    </div>

    <!-- Discipline -->
    <div id="panel-discipline" class="card hidden" role="tabpanel" aria-labelledby="tab-discipline">
      <h2 style="margin-top:0" id="discTitle">المطرودون والإنذارات</h2>
      <div class="row">
        <div>
          <label id="lblDiscDate" for="discDate">تاريخ المرجع</label>
          <div class="date-wrap">
            <input id="discDate" type="date" />
            <span class="cal-ic" aria-hidden="true"></span>
          </div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="discBtn">تحديث القائمة</button>
          <span class="muted" id="discHint">الأسبوع يبدأ السبت وينتهي الجمعة</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row-2">
        <div>
          <div class="pill" id="pillWarn">قائمة الإنذار (أقل من 30 دقيقة في الأسبوع السابق)</div>
          <table id="tblWarn"><thead><tr><th>القارئ</th><th>دقائق الأسبوع السابق</th></tr></thead><tbody></tbody></table>
        </div>
        <div>
          <div class="pill" id="pillRemoved">قائمة المطرودين (أقل من 60 دقيقة في آخر أسبوعين مكتملين)</div>
          <table id="tblRemoved"><thead><tr><th>القارئ</th><th>مجموع آخر أسبوعين</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <footer><span id="footNote">صُنع بحب لتحدي القراء</span></footer>
  </div>

  <script>
    // ======== CONFIG ========
    const API_BASE = 'https://script.google.com/macros/s/AKfycbwu4LmHJU16fyl7jo-ksKO2e-H70H00em6WmhkXMcREKxDcYOrhlJdU8B-YbuF4IvIt/exec';
    const FALLBACK_NAMES = ['Reader 1','Reader 2','Reader 3'];
    const LOGO_SRC = 'logo.svg';

    // ======== DOM ========
    const tabs = document.querySelectorAll('.tab');
    const panels = { log: q('#panel-log'), stats: q('#panel-stats'), reader: q('#panel-reader'), discipline: q('#panel-discipline') };
    const logo = q('#logo');

    const dlNames   = document.getElementById('namesList');
    const dlReaders = document.getElementById('readerList');

    const elName = q('#name');
    const elDate = q('#date');
    const elStatus = q('#status');
    const btnSubmit = q('#submitBtn');
    const durH = q('#durH'), durM = q('#durM'), durS = q('#durS');

    const timerDisplay = q('#timerDisplay');
    const btnOne       = q('#btnOne');
    const oneIcon      = q('#oneIcon');

    const elStatsDate = q('#statsDate');
    const elRangeSel = q('#rangeSel');
    const elTopN = q('#topNSel');
    const elRefresh = q('#refreshBtn');
    const elWeekTypeSel = q('#weekTypeSel');
    const elSegSel = q('#segSel');

    const kpiTotal = q('#kpi-total'), kpiAvg = q('#kpi-avg'), kpiCount = q('#kpi-count');

    const chartMainCanvas = q('#chartMain');
    const chartHistoryCanvas = q('#chartHistory');
    const chartDOWCanvas = q('#chartDOW');

    const tblStreaksBody = q('#tblStreaks tbody');
    const tblWarnBody = q('#tblWarn tbody');
    const tblRemovedBody = q('#tblRemoved tbody');

    const discDate = q('#discDate');
    const discBtn = q('#discBtn');

    const langSel = q('#langSel');

    const segCountsDiv = q('#segCounts');
    const segGrid = q('#segGrid');
    const badgesDiv = q('#badges');

    const readerSel = q('#readerSel');
    const readerMonth = q('#readerMonth');
    const readerBtn = q('#readerBtn');
    const readerCal = q('#readerCal');

    // ======== Helpers ========
    function q(s){ return document.querySelector(s); }
    function todayISO(){ const d = new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function showStatus(msg, ok=true){ elStatus.textContent = msg; elStatus.style.color = ok ? '#8ef5b2' : '#ffb4b4'; }
    function fetchJSON(url, opts){ return fetch(url, opts).then(r=>r.json()); }
    function sumMinutes(arr){ return arr.reduce((a,b)=>a+(Number(b.minutes)||0),0); }
    function setDirRTL(isRTL){ document.body.classList.toggle('rtl', isRTL); document.documentElement.setAttribute('dir', isRTL ? 'rtl' : 'ltr'); }
    function esc(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function makeBar(ctx, labels, data, title){
      if (ctx.__chart) ctx.__chart.destroy();
      const c = new Chart(ctx, { type:'bar',
        data:{ labels, datasets:[{ label:title, data, backgroundColor:'rgba(255,160,0,.85)'}]},
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
      ctx.__chart = c; return c;
    }
    function makeLine(ctx, labels, data, title){
      if (ctx.__chart) ctx.__chart.destroy();
      const c = new Chart(ctx, { type:'line',
        data:{ labels, datasets:[{ label:title, data, tension:.3, fill:false, borderWidth:2, borderColor:'#ffb200', pointRadius:2 }]},
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
      ctx.__chart = c; return c;
    }

    // ======== Init & state ========
    const state = { lang:'ar', names:[], nameSet:new Set(), segMap:new Map(), historyCache:new Map() };
    logo.src = LOGO_SRC;
    const t0 = todayISO();
    elDate.value = t0; elStatsDate.value = t0; q('#readerDate')?.value; discDate.value = t0;
    readerMonth.value = t0.slice(0,7); // yyyy-mm
    langSel.addEventListener('change', (e)=> setDirRTL(e.target.value === 'ar'));

    tabs.forEach(tab => {
      const activate = () => {
        tabs.forEach(x => { x.classList.remove('active'); x.setAttribute('aria-selected','false'); });
        tab.classList.add('active'); tab.setAttribute('aria-selected','true');
        const k = tab.dataset.tab;
        Object.keys(panels).forEach(p => panels[p].classList.toggle('hidden', p !== k));
        if (k === 'stats') loadDashboard();
        if (k === 'reader') loadReaderNames();
        if (k === 'discipline') loadDiscipline();
      };
      tab.addEventListener('click', activate);
      tab.addEventListener('keydown', e => { if (e.key==='Enter' || e.key===' ') activate(); });
    });

    // Names
    function setNames(list){
      const names = (Array.isArray(list) && list.length) ? list : FALLBACK_NAMES;
      dlNames.innerHTML = ''; dlReaders.innerHTML = '';
      for (const n of names) {
        const o1 = document.createElement('option'); o1.value = n; dlNames.appendChild(o1);
        const o2 = document.createElement('option'); o2.value = n; dlReaders.appendChild(o2);
      }
      state.names = names.slice();
      state.nameSet = new Set(names.map(x => x.trim()));
    }
    function loadNames(){
      fetchJSON(`${API_BASE}?action=names`).then(j => setNames(j && j.ok ? j.names : null)).catch(() => setNames(null));
    }
    function loadReaderNames(){ if (dlReaders.childElementCount === 0) loadNames(); }
    loadNames();

    // ======== Timer (زر واحد) ========
    const TIMER_KEY = 'readingTimer:v2';
    const timer = { running:false, startAt:0, elapsed:0, rafId:null };
    function saveTimer(){ try{ localStorage.setItem(TIMER_KEY, JSON.stringify({running:timer.running,startAt:timer.startAt,elapsed:timer.elapsed})); }catch(_){ } }
    function msToHMS(ms){ ms=Math.max(0,Math.floor(ms)); const totalSec=Math.floor(ms/1000); const h=Math.floor(totalSec/3600); const m=Math.floor((totalSec%3600)/60); const s=totalSec%60; return {h,m,s,label:`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`}; }
    function fillInputsFromElapsed(){ if (!timer.running && timer.elapsed===0) return; const {h,m,s}=msToHMS(timer.elapsed); durH.value=h; durM.value=m; durS.value=s; }
    function updateTimerUI(){ const t=msToHMS(timer.elapsed); timerDisplay.textContent=t.label; fillInputsFromElapsed(); oneIcon.setAttribute('d', timer.running ? 'M6 5h4v14H6zM14 5h4v14h-4z' : 'M8 5v14l11-7z'); }
    function tick(){ if (!timer.running) return; timer.elapsed = Date.now()-timer.startAt; updateTimerUI(); timer.rafId = requestAnimationFrame(tick); }
    function startTick(){ cancelAnimationFrame(timer.rafId); timer.rafId=requestAnimationFrame(tick); }
    function toggleTimer(){ if (timer.running){ timer.running=false; cancelAnimationFrame(timer.rafId); timer.elapsed=Date.now()-timer.startAt; } else { timer.running=true; timer.startAt=Date.now()-timer.elapsed; startTick(); } saveTimer(); updateTimerUI(); }
    function resetTimer(){ timer.running=false; cancelAnimationFrame(timer.rafId); timer.elapsed=0; durH.value=''; durM.value=''; durS.value=''; saveTimer(); updateTimerUI(); }
    function loadTimer(){ try{ const t=JSON.parse(localStorage.getItem(TIMER_KEY)||'{}'); if (typeof t.elapsed==='number') timer.elapsed=t.elapsed; if (t.running && t.startAt){ timer.running=true; timer.startAt=t.startAt; startTick(); } else updateTimerUI(); }catch(_){ updateTimerUI(); } }
    btnOne.addEventListener('click', toggleTimer);
    let holdT=null; btnOne.addEventListener('pointerdown', ()=>{ btnOne.classList.add('hold'); holdT=setTimeout(()=>{ resetTimer(); btnOne.classList.remove('hold'); }, 700); });
    ['pointerup','pointerleave','pointercancel'].forEach(ev=>btnOne.addEventListener(ev, ()=>{ btnOne.classList.remove('hold'); clearTimeout(holdT); }));
    document.addEventListener('keydown', (e)=>{ if (e.code==='Space' && document.activeElement.tagName!=='INPUT'){ e.preventDefault(); toggleTimer(); }});
    loadTimer();

    // ======== Submit ========
    btnSubmit.addEventListener('click', async () => {
      const raw = (elName.value || '').trim();
      let name = raw;
      if (!state.nameSet.has(name)) {
        const cand = state.names.filter(n => n.toLowerCase() === raw.toLowerCase());
        if (cand.length === 1) name = cand[0];
      }
      if (!state.nameSet.has(name)) { showStatus('الاسم غير موجود في القائمة. اختر من الاقتراحات.', false); return; }

      const h = Number(durH.value)||0, m = Number(durM.value)||0, s = Number(durS.value)||0;
      const date = elDate.value;
      const minutes = +(h*60 + m + s/60).toFixed(2);
      if (minutes <= 0 || !isFinite(minutes) || !date || m<0 || m>59 || s<0 || s>59 || h<0) {
        showStatus('تحقَّق من المدخلات', false); return;
      }

      btnSubmit.disabled = true; showStatus('جاري الحفظ…');
      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ name, minutes, date })
        });
        const ct = res.headers.get('content-type') || '';
        const j = ct.includes('application/json') ? await res.json() : JSON.parse(await res.text());
        if (j.ok) { showStatus('تم الحفظ'); durH.value=''; durM.value=''; durS.value=''; resetTimer(); }
        else { showStatus(j.error || 'حدث خطأ', false); }
      } catch (e) { showStatus(String(e.message || e), false); }
      finally { btnSubmit.disabled = false; }
    });

    // ======== STREAK HELPERS ========
    const STREAK_LOOKBACK_DAYS = 180;
    const WEEKEND_WINDOW_DAYS  = 30;

    function dateKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function parseISO(s){ return new Date(`${s}T00:00:00`); }
    function addDays(d, n){ const k = new Date(d); k.setDate(k.getDate()+n); return k; }
    function diffDays(a,b){ return Math.round((parseISO(a)-parseISO(b))/86400000); }
    function getPrevDate(range, dateStr){
      const d = new Date((dateStr||todayISO())+'T00:00:00');
      if(range==='day') d.setDate(d.getDate()-1);
      else if(range==='week') d.setDate(d.getDate()-7);
      else if(range==='month') d.setMonth(d.getMonth()-1);
      return d.toISOString().slice(0,10);
    }
    function hitsSet(points, threshold=1){
      const set = new Set();
      for(const p of (points||[])){
        const m = Number(p.minutes)||0;
        if(m >= threshold) set.add(p.date);
      }
      return set;
    }
    function computeStreakFromSet(hitSet, refDateStr){
      const ref = parseISO(refDateStr);
      let cur = 0;
      for(let d = new Date(ref); ; d = addDays(d, -1)){
        const k = dateKey(d);
        if(hitSet.has(k)) cur++;
        else break;
      }
      let longest = 0, run = 0;
      for(let i=STREAK_LOOKBACK_DAYS-1; i>=0; i--){
        const d = addDays(ref, -i);
        if(hitSet.has(dateKey(d))){ run++; longest = Math.max(longest, run); }
        else run = 0;
      }
      return { current: cur, longest };
    }

    // ======== Dashboard ========
    let chartHistory;

    async function loadDashboard(){
      const d = elStatsDate.value || todayISO();
      const weekType = elWeekTypeSel.value;
      const range = elRangeSel.value;

      // نحتاج دائمًا لإحصاءات "الأسبوع" للشارات
      const [statsCurrent, statsWeek, statsWeekPrev, segRes, dowRes] = await Promise.all([
        fetchJSON(`${API_BASE}?action=stats&range=${range}&date=${d}&weekType=${weekType}`),
        fetchJSON(`${API_BASE}?action=stats&range=week&date=${d}&weekType=${weekType}`),
        fetchJSON(`${API_BASE}?action=stats&range=week&date=${getPrevDate('week',d)}&weekType=${weekType}`),
        fetchJSON(`${API_BASE}?action=segments&date=${d}&weeks=12`),
        fetchJSON(`${API_BASE}?action=dow&date=${d}&weeks=12`)
      ]).catch(()=>[null,null,null,null,null]);

      // شارات + سلاسل + DOW
      const weekRows = (statsWeek?.data)||[];
      const namesSet = new Set(weekRows.map(r => r.name));
      const weekMapNow  = new Map(weekRows.map(r => [r.name, Number(r.minutes)||0]));
      const weekMapPrev = new Map((statsWeekPrev?.data||[]).map(r => [r.name, Number(r.minutes)||0]));

      // history لكل قارئ أسبوعي (للسلاسل والويكند)
      const byNameHistory = {};
      await Promise.all(
        [...namesSet].map(n =>
          fetchJSON(`${API_BASE}?action=history&name=${encodeURIComponent(n)}&days=${STREAK_LOOKBACK_DAYS}&date=${d}`)
            .then(j => { byNameHistory[n] = j && j.points ? j.points : []; })
            .catch(()=>{ byNameHistory[n] = []; })
        )
      );

      // قارئ الفترة (الأسبوع)
      let bestName='—', bestVal=0;
      weekMapNow.forEach((v,k)=>{ if(v>bestVal){ bestVal=v; bestName=k; } });

      // الأفضل تحسنًا (فرق أسبوع حالي - سابق)
      let impName='—', impVal=-Infinity;
      weekMapNow.forEach((v,k)=>{ const diff = v - (weekMapPrev.get(k)||0); if(diff>impVal){ impVal=diff; impName=k; } });
      if(!isFinite(impVal)) impVal = 0;

      // بطل نهاية الأسبوع (آخر 30 يوم: جمعة/سبت)
      let wkndName='—', wkndVal=0;
      [...namesSet].forEach(n=>{
        const pts = byNameHistory[n]||[];
        let fri=0, sat=0;
        pts.forEach(p=>{
          if(diffDays(d, p.date) <= WEEKEND_WINDOW_DAYS-1){
            const dd = parseISO(p.date).getDay();
            const mm = Math.max(0, Number(p.minutes)||0);
            if(dd===5) fri += mm;  // الجمعة
            if(dd===6) sat += mm;  // السبت
          }
        });
        const sum = fri + sat;
        if(sum > wkndVal){ wkndVal = sum; wkndName = n; }
      });

      // السلاسل (آخر 180 يوم)
      const streakMap = new Map();
      [...namesSet].forEach(n=>{
        const set = hitsSet(byNameHistory[n], 1);
        streakMap.set(n, computeStreakFromSet(set, d));
      });
      let bestStreakName='—', bestStreakLen=0, currentStreak=0;
      streakMap.forEach((s, n)=>{ if(s.longest > bestStreakLen){ bestStreakLen = s.longest; currentStreak = s.current; bestStreakName = n; } });

      function renderStreakStrip(days=30, name){
        if(!name || !byNameHistory[name]) return '';
        const set30 = new Set(
          (byNameHistory[name]||[])
            .filter(p => (Number(p.minutes)||0) >= 1 && diffDays(d, p.date) <= days-1)
            .map(p => p.date)
        );
        const frag = document.createDocumentFragment();
        for(let i=days-1; i>=0; i--){
          const dd = addDays(parseISO(d), -i);
          const span=document.createElement('span');
          if(set30.has(dateKey(dd))) span.className='on';
          frag.appendChild(span);
        }
        const wrap=document.createElement('div');
        wrap.className='streak-strip'; wrap.appendChild(frag);
        return wrap.outerHTML;
      }

      const fmt=v=>`${Math.max(0,Math.round(Number(v)||0))} دقيقة`;
      const card=(icon,title,name,sub)=>`<div class="badge"><div class="ic">${icon}</div><div class="txt"><div class="title">${title}</div><div class="name">${esc(name||'—')}</div><small>${sub||''}</small></div></div>`;
      badgesDiv.innerHTML =
        card('🏅','قارئ الفترة',bestName,fmt(bestVal)) +
        card('📈','الأفضل تحسّنًا',impName,`+${fmt(impVal)}`) +
        card('🎉','بطل نهاية الأسبوع',wkndName,fmt(wkndVal)) +
        `<div class="badge"><div class="ic">🔥</div><div class="txt"><div class="title">أطول سلسلة نشطة</div>
          <div class="name">${esc(bestStreakName||'—')}</div><small>الحالية ${currentStreak||0} · الأطول ${bestStreakLen||0} يوم</small>${renderStreakStrip(30,bestStreakName)}</div></div>`;

      // DOW ثابت (آخر 12 أسبوع)
      if(dowRes && dowRes.ok){
        const items = dowRes.items || [];
        makeBar(chartDOWCanvas, items.map(i=>i.label), items.map(i=>Math.round(Number(i.avg)||0)), 'DOW');
      }

      // جدول السلاسل
      tblStreaksBody.innerHTML = '';
      const streakRows = [...namesSet].map(n => ({ name:n, ...(streakMap.get(n)||{current:0,longest:0}) }))
        .filter(s => s.current>0 || s.longest>0)
        .sort((a,b)=> b.current - a.current || b.longest - a.longest);
      if(streakRows.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="muted" colspan="3">لا يوجد سلاسل</td>`;
        tblStreaksBody.appendChild(tr);
      } else {
        for(const s of streakRows){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${esc(s.name)}</td><td>${s.current}</td><td>${s.longest}</td>`;
          tblStreaksBody.appendChild(tr);
        }
      }

      // ——— القسم المتغيّر حسب الفترة ———
      const rowsNow = (statsCurrent && statsCurrent.data) ? statsCurrent.data : [];
      const total   = sumMinutes(rowsNow);
      const active  = rowsNow.length;
      kpiTotal.textContent = total;
      kpiCount.textContent = active;
      kpiAvg.textContent   = active ? Math.round(total/active) : 0;

      // فلترة التصنيف + Top-N
      const selectedSeg = elSegSel.value;
      let rows = rowsNow.slice(0);
      if(selectedSeg !== 'all'){
        rows = rows.filter(x => (state.segMap.get(x.name) || 'mixed') === selectedSeg);
      }
      const topNVal = elTopN.value;
      if (topNVal !== 'All') rows = rows.slice(0, Number(topNVal));
      makeBar(chartMainCanvas, rows.map(x=>x.name), rows.map(x=>Math.round(Number(x.minutes)||0)), 'Total');

      // التصنيفات
      state.segMap = new Map();
      segGrid.innerHTML = '';
      const segRes = await fetchJSON(`${API_BASE}?action=segments&date=${d}&weeks=12`).catch(()=>null);
      if(segRes && segRes.ok){
        (segRes.segments||[]).forEach(s=>state.segMap.set(s.name,s.segment));
        const s = segRes.summary || {steady:0,sprinter:0,weekend:0,mixed:0,inactive:0};
        segCountsDiv.textContent = `مستقرون: ${s.steady} · اندفاعيون: ${s.sprinter} · نهاية الأسبوع: ${s.weekend} · متنوع: ${s.mixed} · غير نشط: ${s.inactive}`;
        const labels={steady:'مستقرون',sprinter:'اندفاعيون',weekend:'نهاية الأسبوع',mixed:'متنوع',inactive:'غير نشط'};
        const groups={steady:[],sprinter:[],weekend:[],mixed:[],inactive:[]};
        (segRes.segments||[]).forEach(r=>{ if(groups[r.segment]) groups[r.segment].push(r.name); });
        const sections = Object.keys(groups).map(key=>{
          const names = groups[key].sort((a,b)=>a.localeCompare(b,'ar'));
          const chips = names.map(n=>`<span class="chip" data-name="${esc(n)}" data-seg="${key}">${esc(n)}</span>`).join('') || `<span class="muted">—</span>`;
          return `<div class="seg-card"><div class="seg-head">${labels[key]} <small>(${names.length})</small></div><div class="seg-names">${chips}</div></div>`;
        }).join('');
        segGrid.innerHTML = sections;
      } else {
        segCountsDiv.textContent = 'لا توجد بيانات للتصنيف.';
      }
    }

    elRefresh.addEventListener('click', loadDashboard);
    elTopN.addEventListener('change', loadDashboard);
    elRangeSel.addEventListener('change', loadDashboard);
    elWeekTypeSel.addEventListener('change', loadDashboard);
    elSegSel.addEventListener('change', loadDashboard);
    q('#tab-stats').addEventListener('click', () => { if (!chartMainCanvas.__chart) loadDashboard(); });

    // Click name chip → open Reader tab with that user
    segGrid.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip) return;
      const name = chip.dataset.name;
      q('#tab-reader').click();
      readerSel.value = name;
      setTimeout(() => readerBtn.click(), 50);
    });

    // ======== Reader history + Calendar ========
    function normalizeName(raw){
      const r = (raw || '').trim();
      if (state.nameSet.has(r)) return r;
      const cand = state.names.filter(n => n.toLowerCase() === r.toLowerCase());
      return cand.length === 1 ? cand[0] : null;
    }
    function groupByDate(points){ const m = new Map(); (points||[]).forEach(p=>{ m.set(p.date, (m.get(p.date)||0) + (Number(p.minutes)||0)); }); return m; }
    function renderMonthCalendar(points, ym){ // ym: 'yyyy-mm'
      const [yy, mm] = ym.split('-').map(n=>+n);
      const first = new Date(yy, mm-1, 1);
      const lastDay = new Date(yy, mm, 0).getDate();
      const dowNames = ['السبت','الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة']; // بدء السبت
      const byDate = groupByDate(points);
      readerCal.innerHTML = '';
      // DOW header
      for(const d of dowNames){
        const h = document.createElement('div'); h.textContent=d; h.className='dow'; readerCal.appendChild(h);
      }
      // leading blanks
      let startIdx = (first.getDay()+1)%7; // Saturday=0
      for(let i=0;i<startIdx;i++){ const cell=document.createElement('div'); readerCal.appendChild(cell); }
      // days
      for(let day=1; day<=lastDay; day++){
        const cell = document.createElement('div'); cell.className='cal-cell';
        const key = `${yy}-${String(mm).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const has = (byDate.get(key)||0) > 0;
        if(has){ cell.classList.add('has'); const dot=document.createElement('div'); dot.className='dot'; cell.appendChild(dot); }
        const dspan=document.createElement('div'); dspan.textContent=day; dspan.className='d'; cell.appendChild(dspan);
        readerCal.appendChild(cell);
      }
    }
    async function loadReaderHistory(){
      const nameRaw = readerSel.value;
      const name = normalizeName(nameRaw);
      if(!name){ alert('اختر قارئًا من القائمة'); return; }
      const ym = readerMonth.value || todayISO().slice(0,7);

      // اجلب 120 يومًا لتغطية شهرين على الأقل
      const d = todayISO();
      const cacheKey = `${name}:${d}:120`;
      let pts;
      if(state.historyCache.has(cacheKey)){
        pts = state.historyCache.get(cacheKey);
      } else {
        const res = await fetchJSON(`${API_BASE}?action=history&name=${encodeURIComponent(name)}&days=120&date=${d}`).catch(()=>null);
        pts = (res && res.points) ? res.points : [];
        state.historyCache.set(cacheKey, pts);
      }

      // رسم الخط
      makeLine(chartHistoryCanvas, pts.map(p=>p.date), pts.map(p=>p.minutes), 'Minutes');

      // تقويم الشهر (أيام القراءة فقط تُعلّم بنقطة خضراء، والباقي بدون علامات)
      const monthPts = pts.filter(p => (p.date||'').startsWith(ym));
      renderMonthCalendar(monthPts, ym);
    }
    readerBtn.addEventListener('click', loadReaderHistory);
    q('#tab-reader').addEventListener('click', () => { if (!chartHistoryCanvas.__chart) loadReaderHistory(); });

    // ======== Discipline ========
    async function loadDiscipline(){
      const d = discDate.value || todayISO();
      const res = await fetchJSON(`${API_BASE}?action=discipline&date=${d}`);
      tblWarnBody.innerHTML = ''; tblRemovedBody.innerHTML = '';
      (res.warning || []).forEach(r => {
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${esc(r.name)}</td><td>${Math.round(Number(r.minutes)||0)}</td>`; tblWarnBody.appendChild(tr);
      });
      (res.removed || []).forEach(r => {
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${esc(r.name)}</td><td>${Math.round(Number(r.minutes)||0)}</td>`; tblRemovedBody.appendChild(tr);
      });
    }
    discBtn.addEventListener('click', loadDiscipline);
    q('#tab-discipline').addEventListener('click', () => { if (!tblWarnBody.childElementCount) loadDiscipline(); });
  </script>
</body>
</html>
