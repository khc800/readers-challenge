<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تحدي القراء</title>

  <!-- Favicon / tab icon -->
  <link rel="icon" type="image/svg+xml" href="logo2.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="mask-icon" href="logo.svg" color="#ff8f00">
  <meta name="theme-color" content="#212e3e">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* Make datalist inputs expand nicely */
    input[list]{ width: 100%; }

    :root{
      --brand-dark:#212e3e; --brand-accent:#ff8f00; --brand-accent-2:#feaf00;
      --ink:#ffffff; --ink-dim:#d1d1d1; --ink-muted:#b7b7b7;
      --card:#263347; --card-2:#2f3e56; --ring:#3e4f6a; --ok:#1db954;
      --bg1:#1a2433; --bg2:#212e3e;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg1),var(--bg2) 60%,var(--bg1)); color:var(--ink); }
    header{ max-width:1100px; margin:24px auto 0; padding:0 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header .brand{ display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px; }
    header img.logo{ height:36px; width:auto; display:block; }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    select,input,button{ border-radius:12px; border:1px solid var(--ring); background:var(--card);
      color:var(--ink); padding:10px 12px; outline:none; }
    button{ border-color:transparent; background:linear-gradient(180deg,var(--brand-accent),var(--brand-accent-2));
      color:#111; font-weight:800; cursor:pointer; }
    .wrap{ max-width:1100px; margin:16px auto 40px; padding:0 16px; }
    .tabs{ display:flex; gap:8px; margin-bottom:16px; }
    .tab{ padding:10px 16px; background:var(--card); border:1px solid var(--ring); border-radius:12px; cursor:pointer; user-select:none; }
    .tab.active{ background:var(--card-2); border-color:var(--brand-accent-2); box-shadow:0 0 0 2px rgba(255,143,0,.25) inset; }
    .card{ background:rgba(33,46,62,.65); backdrop-filter:blur(6px); border:1px solid var(--ring); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .row{ display:grid; grid-template-columns:repeat(4,1fr); gap:16px; }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
    @media (max-width:980px){ .row{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width:640px){ .row, .row-3{ grid-template-columns:1fr; } header{ flex-direction:column; align-items:flex-start; gap:8px; } }
    label{ display:block; font-size:14px; color:var(--ink-dim); margin-bottom:6px; }
    .muted{ color:var(--ink-muted); font-size:13px; }
    .spacer{ height:16px; }
    .hidden{ display:none; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid var(--ring); font-size:12px; }
    .kpi{ text-align:center; background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px; }
    .kpi .v{ font-size:28px; font-weight:800; color:var(--brand-accent-2); }
    footer{ text-align:center; margin-top:20px; color:var(--ink-muted); font-size:12px; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid var(--ring); padding:8px 6px; text-align:right; }
    th{ color:var(--ink-dim); font-weight:600; }

    /* Equal widths for HH:MM:SS */
    .timegrid{
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }
    .timegrid input{
      width: 100%;
      min-width: 0;
      text-align: center;
      direction: ltr;
    }
    /* Hide number spinners */
    .timegrid input::-webkit-outer-spin-button,
    .timegrid input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    .timegrid input[type="number"]{ -moz-appearance: textfield; }

    /* Timer UI */
    .timer{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    #timerDisplay{
      text-align:center; direction:ltr;
      font-size:28px; font-weight:800; letter-spacing:1.5px;
      padding:10px 12px; border:1px solid var(--ring); background:var(--card); border-radius:12px;
    }
/* Center the row of icons */
.timerBtns{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

.timerBtns .icon{
  --size: 44px;
  width: var(--size);
  height: var(--size);
  aspect-ratio: 1 / 1;
  border-radius: 999px;
  display: grid; place-items: center;
  padding: 0;
  border: 1px solid var(--ring);
  background: linear-gradient(180deg,var(--brand-accent),var(--brand-accent-2));
  box-shadow: 0 2px 8px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
  cursor: pointer;
}

.timerBtns .icon svg{
  width: 22px; height: 22px;
  fill: #111;                 /* icon color */
}

.timerBtns .icon:hover:not(:disabled){ transform: translateY(-1px); }
.timerBtns .icon:active:not(:disabled){ transform: translateY(0); }
.timerBtns .icon:disabled{ opacity:.55; cursor: default; }


/* Optional tiny visual tweaks per action */
.timerBtns .play  { }
.timerBtns .pause { filter: saturate(.9) brightness(1.02); }
.timerBtns .reset { filter: saturate(.85); }


    /* RTL helpers */
    body.rtl{ direction: rtl; } body.rtl .row, body.rtl .row-3{ direction: rtl; }
  </style>
</head>
<body class="rtl">
  <header>
    <div class="brand">
      <img class="logo" id="logo" alt="Logo" />
      <div id="appTitle">تحدي القراء</div>
    </div>
    <div class="controls">
      <select id="langSel" title="اللغة">
        <option value="ar" selected>العربية</option>
        <option value="en">English</option>
      </select>
      <select id="weekTypeSel" title="نمط الأسبوع">
        <option value="rolling">٧ أيام متحركة</option>
        <option value="calendar">أسبوع تقويمي (السبت–الجمعة)</option>
      </select>
    </div>
  </header>

  <div class="wrap">
    <div class="tabs" role="tablist" aria-label="Pages">
      <div class="tab active" data-tab="log" role="tab" aria-selected="true" tabindex="0" id="tab-log">تسجيل القراءة</div>
      <div class="tab" data-tab="stats" role="tab" aria-selected="false" tabindex="0" id="tab-stats">لوحة الإحصائيات</div>
      <div class="tab" data-tab="reader" role="tab" aria-selected="false" tabindex="0" id="tab-reader">سجل القارئ</div>
      <div class="tab" data-tab="discipline" role="tab" aria-selected="false" tabindex="0" id="tab-discipline">المطرودون/الإنذارات</div>
    </div>

    <!-- Log Form -->
    <div id="panel-log" class="card" role="tabpanel" aria-labelledby="tab-log">
      <h2 id="logTitle" style="margin-top:0">إضافة جلسة قراءة</h2>
      <div class="row">
        <div>
          <label for="name" id="lblReader">القارئ</label>
          <input id="name" list="namesList" autocomplete="off" placeholder="اسمك…" />
          <datalist id="namesList"></datalist>
          <div class="muted" id="nameHint">لم تجد اسمك؟ تواصل مع المجلس الأعلى</div>
        </div>

        <!-- HH:MM:SS duration + Timer -->
        <div>
          <label id="lblDuration">المدة (س:د:ث)</label>
          <div class="timegrid">
            <input id="durH" type="number" min="0" step="1" placeholder="س" inputmode="numeric" />
            <input id="durM" type="number" min="0" max="59" step="1" placeholder="د" inputmode="numeric" />
            <input id="durS" type="number" min="0" max="59" step="1" placeholder="ث" inputmode="numeric" />
          </div>
          <div class="timer">
            <div id="timerDisplay">00:00:00</div>
<div class="timerBtns">
  <!-- Play -->
  <button id="btnStart" class="icon play" type="button" aria-label="بدء" title="بدء">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M8 5v14l11-7z"></path>
    </svg>
  </button>

  <!-- Pause -->
  <button id="btnPause" class="icon pause" type="button" aria-label="إيقاف مؤقت" title="إيقاف مؤقت" disabled>
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M6 5h4v14H6zM14 5h4v14h-4z"></path>
    </svg>
  </button>

  <!-- Reset -->
  <button id="btnReset" class="icon reset" type="button" aria-label="إعادة ضبط" title="إعادة ضبط" disabled>
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 5V2L7.5 6.5 12 11V8a6 6 0 1 1-6 6H4a8 8 0 1 0 8-8z"></path>
    </svg>
  </button>
</div>


            <div class="muted">يمكنك أيضاً تعديل الوقت يدوياً في الحقول أعلاه</div>
          </div>
          <div class="muted" id="durationHint">أدخل الساعات والدقائق والثواني</div>
        </div>

        <div>
          <label for="date" id="lblDate">التاريخ</label>
          <input id="date" type="date" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="submitBtn">حفظ</button>
          <span class="muted" id="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div id="panel-stats" class="card hidden" role="tabpanel" aria-labelledby="tab-stats">
      <h2 id="dashTitle" style="margin-top:0">لوحة الإحصائيات</h2>
      <div class="row">
        <div>
          <label for="statsDate" id="lblRefDate">تاريخ المرجع</label>
          <input id="statsDate" type="date" />
        </div>
        <div>
          <label for="rangeSel" id="lblRange">المدى</label>
          <select id="rangeSel">
            <option value="day">اليوم</option>
            <option value="week">الأسبوع</option>
            <option value="month">الشهر</option>
            <option value="all">كل الوقت</option>
          </select>
        </div>
        <div>
          <label for="topNSel" id="lblTopN" class="muted" style="display:block;">أفضل N</label>
          <select id="topNSel">
            <option>10</option><option selected>20</option><option>50</option><option>100</option><option>All</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="refreshBtn">تحديث</button>
          <span class="muted" id="rangeHint">اليوم = نفس التاريخ · الأسبوع = ٧ أيام متحركة أو أسبوع تقويمي (السبت–الجمعة) · الشهر = شهر تقويمي</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row-3" id="kpiRow">
        <div class="kpi"><div class="v" id="kpi-total">–</div><div class="muted" id="kpiTotalLabel">إجمالي الدقائق</div></div>
        <div class="kpi"><div class="v" id="kpi-avg">–</div><div class="muted" id="kpiAvgLabel">متوسط لكل قارئ</div></div>
        <div class="kpi"><div class="v" id="kpi-count">–</div><div class="muted" id="kpiCountLabel">عدد القرّاء النشطين</div></div>
      </div>

      <div class="spacer"></div>

      <div class="card" style="background:transparent; border:0; padding:0;">
        <div style="display:grid; grid-template-columns:1fr; gap:24px;">
          <div><div class="pill" id="pillByReader">حسب القارئ</div><canvas id="chartMain" height="140"></canvas></div>
          <div>
            <div class="pill" id="pillStreaks">سلاسل الأيام المتتالية (≥ دقيقة يومياً)</div>
            <table id="tblStreaks">
              <thead><tr><th id="thReader">القارئ</th><th id="thCurrent">الحالية</th><th id="thLongest">الأطول</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Per-Reader History -->
    <div id="panel-reader" class="card hidden" role="tabpanel" aria-labelledby="tab-reader">
      <h2 id="readerTitle" style="margin-top:0">سجل القارئ (يومياً)</h2>
      <div class="row">
        <div>
          <label for="readerSel" id="lblReaderSel">القارئ</label>
          <input id="readerSel" list="readerList" autocomplete="off" placeholder="ابحث عن قارئ…" />
          <datalist id="readerList"></datalist>
        </div>
        <div>
          <label for="daysSel" id="lblDays">المدى</label>
          <select id="daysSel">
            <option value="14">14</option>
            <option value="30" selected>30</option>
            <option value="60">60</option>
            <option value="90">90</option>
            <option value="all">الكل</option>
          </select>
        </div>
        <div>
          <label for="readerDate" id="lblReaderDate">تاريخ المرجع</label>
          <input id="readerDate" type="date" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="readerBtn">عرض</button>
          <span class="muted" id="readerHint">مجموع يومي خلال المدى المختار</span>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="pillHistory">الدقائق اليومية</div>
      <canvas id="chartHistory" height="160"></canvas>
    </div>

    <!-- Discipline (Removed/Warning) -->
    <div id="panel-discipline" class="card hidden" role="tabpanel" aria-labelledby="tab-discipline">
      <h2 style="margin-top:0" id="discTitle">المطرودون والإنذارات</h2>
      <div class="row">
        <div>
          <label id="lblDiscDate" for="discDate">تاريخ المرجع</label>
          <input id="discDate" type="date" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="discBtn">تحديث القائمة</button>
          <span class="muted" id="discHint">الأسبوع يبدأ السبت وينتهي الجمعة</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="pill" id="pillWarn">قائمة الإنذار (أقل من 30 دقيقة في الأسبوع السابق)</div>
      <table id="tblWarn"><thead><tr><th>القارئ</th><th>دقائق الأسبوع السابق</th></tr></thead><tbody></tbody></table>

      <div class="spacer"></div>

      <div class="pill" id="pillRemoved">قائمة المطرودين (أقل من 60 دقيقة في آخر أسبوعين مكتملين)</div>
      <table id="tblRemoved"><thead><tr><th>القارئ</th><th>مجموع آخر أسبوعين</th></tr></thead><tbody></tbody></table>
    </div>

    <footer><span id="footNote">صُنع بحب لتحدي القراء</span></footer>
  </div>

  <script>
    // ======== CONFIG ========
    const API_BASE = 'https://script.google.com/macros/s/AKfycbwDCq-oJhIoFl5H2mXX_rBU_8r69nlNjuWErjySN-5fgVwfxiWgbQR0ephdfNn4s1LG/exec';
    const FALLBACK_NAMES = ['Reader 1','Reader 2','Reader 3'];
    const LOGO_SRC = 'logo.svg';

    // ======== DOM ========
    const tabs = document.querySelectorAll('.tab');
    const panels = { log: q('#panel-log'), stats: q('#panel-stats'), reader: q('#panel-reader'), discipline: q('#panel-discipline') };
    const logo = q('#logo');

    // Datalists for autocomplete
    const dlNames   = document.getElementById('namesList');
    const dlReaders = document.getElementById('readerList');

    // Log form
    const elName = q('#name');
    const elDate = q('#date');
    const elStatus = q('#status');
    const btnSubmit = q('#submitBtn');
    const durH = q('#durH'), durM = q('#durM'), durS = q('#durS');

    // Timer elements
    const timerDisplay = q('#timerDisplay');
    const btnStart     = q('#btnStart');
    const btnPause     = q('#btnPause');
    const btnReset     = q('#btnReset');
    // const btnStopFill  = q('#btnStopFill');

    // Dashboard controls
    const elStatsDate = q('#statsDate');
    const elRangeSel = q('#rangeSel');
    const elTopN = q('#topNSel');
    const elRefresh = q('#refreshBtn');
    const elWeekTypeSel = q('#weekTypeSel');

    // KPIs
    const kpiTotal = q('#kpi-total'), kpiAvg = q('#kpi-avg'), kpiCount = q('#kpi-count');

    // Dashboard chart/table
    const chartMainCanvas = q('#chartMain');
    const tblStreaksBody = q('#tblStreaks tbody');

    // Reader history
    const elReaderSel = q('#readerSel');
    const elDaysSel = q('#daysSel');
    const elReaderDate = q('#readerDate');
    const elReaderBtn = q('#readerBtn');
    const chartHistoryCanvas = q('#chartHistory');

    // Discipline
    const discDate = q('#discDate');
    const discBtn = q('#discBtn');
    const tblWarnBody = q('#tblWarn tbody');
    const tblRemovedBody = q('#tblRemoved tbody');

    // Language
    const langSel = q('#langSel');

    // ======== Helpers ========
    function q(s){ return document.querySelector(s); }
    function todayISO(){ const d = new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function showStatus(msg, ok=true){ elStatus.textContent = msg; elStatus.style.color = ok ? '#8ef5b2' : '#ffb4b4'; }
    function fetchJSON(url, opts){ return fetch(url, opts).then(r=>r.json()); }
    function sumMinutes(arr){ return arr.reduce((a,b)=>a+(b.minutes||0),0); }

    function makeBar(ctx, labels, data, title){
      if (ctx.__chart) ctx.__chart.destroy();
      const c = new Chart(ctx, { type:'bar',
        data:{ labels, datasets:[{ label:title, data, backgroundColor:'rgba(255,143,0,0.6)'}]},
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
      ctx.__chart = c; return c;
    }
    function makeLine(ctx, labels, data, title){
      if (ctx.__chart) ctx.__chart.destroy();
      const c = new Chart(ctx, { type:'line',
        data:{ labels, datasets:[{ label:title, data, tension:.3, fill:false, borderWidth:2, borderColor:'#ff8f00', pointRadius:2 }]},
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
      ctx.__chart = c; return c;
    }
    function setDirRTL(isRTL){ document.body.classList.toggle('rtl', isRTL); document.documentElement.setAttribute('dir', isRTL ? 'rtl' : 'ltr'); }

    // ======== Init & state ========
    const state = { lang: 'ar', names: [], nameSet: new Set() };
    logo.src = LOGO_SRC;
    const t = todayISO();
    elDate.value = t; elStatsDate.value = t; elReaderDate.value = t; discDate.value = t;

    // Tabs
    tabs.forEach(tab => {
      const activate = () => {
        tabs.forEach(x => { x.classList.remove('active'); x.setAttribute('aria-selected', 'false'); });
        tab.classList.add('active'); tab.setAttribute('aria-selected', 'true');
        const k = tab.dataset.tab;
        Object.keys(panels).forEach(p => panels[p].classList.toggle('hidden', p !== k));
        if (k === 'stats') loadDashboard();
        if (k === 'reader') loadReaderNames();
        if (k === 'discipline') loadDiscipline();
      };
      tab.addEventListener('click', activate);
      tab.addEventListener('keydown', e => { if (e.key==='Enter' || e.key===' ') activate(); });
    });

    // Language selector
    langSel.addEventListener('change', (e)=> { setDirRTL(e.target.value === 'ar'); });

    // ======== Names (datalist) ========
    function setNames(list){
      const names = (Array.isArray(list) && list.length) ? list : FALLBACK_NAMES;
      dlNames.innerHTML = ''; dlReaders.innerHTML = '';
      for (const n of names) {
        const o1 = document.createElement('option'); o1.value = n; dlNames.appendChild(o1);
        const o2 = document.createElement('option'); o2.value = n; dlReaders.appendChild(o2);
      }
      state.names = names.slice();
      state.nameSet = new Set(names.map(x => x.trim()));
    }
    function loadNames(){
      fetchJSON(`${API_BASE}?action=names`)
        .then(j => setNames(j && j.ok ? j.names : null))
        .catch(() => setNames(null));
    }
    function loadReaderNames(){ if (dlReaders.childElementCount === 0) loadNames(); }
    loadNames();

    // ======== Timer logic ========
    const TIMER_KEY = 'readingTimer:v1';
    const timer = { running:false, startAt:0, elapsed:0, rafId:null };

    function saveTimer(){
      try{ localStorage.setItem(TIMER_KEY, JSON.stringify({
        running: timer.running, startAt: timer.startAt, elapsed: timer.elapsed
      })); }catch(_){}
    }
    function msToHMS(ms){
      ms = Math.max(0, Math.floor(ms));
      const totalSec = Math.floor(ms/1000);
      const h = Math.floor(totalSec/3600);
      const m = Math.floor((totalSec%3600)/60);
      const s = totalSec%60;
      return { h, m, s, label:
        `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` };
    }
    function fillInputsFromElapsed(){
      const {h,m,s} = msToHMS(timer.elapsed);
      durH.value = h; durM.value = m; durS.value = s;
    }
    function updateTimerUI(){
      const t = msToHMS(timer.elapsed);
      timerDisplay.textContent = t.label;
      fillInputsFromElapsed();
      btnStart.disabled    = timer.running;
      btnPause.disabled    = !timer.running;
      btnReset.disabled    = !timer.running && timer.elapsed === 0;
      // btnStopFill.disabled = !timer.running && timer.elapsed === 0;
    }
    function tick(){
      if (!timer.running) return;
      timer.elapsed = Date.now() - timer.startAt;
      updateTimerUI();
      timer.rafId = requestAnimationFrame(tick);
    }
    function startTick(){ cancelAnimationFrame(timer.rafId); timer.rafId = requestAnimationFrame(tick); }
    function startTimer(){
      if (timer.running) return;
      timer.running = true;
      timer.startAt = Date.now() - timer.elapsed;
      saveTimer(); updateTimerUI(); startTick();
    }
    function pauseTimer(){
      if (!timer.running) return;
      timer.running = false;
      cancelAnimationFrame(timer.rafId);
      timer.elapsed = Date.now() - timer.startAt;
      saveTimer(); updateTimerUI();
    }
    function resetTimer(){
      timer.running = false;
      cancelAnimationFrame(timer.rafId);
      timer.elapsed = 0;
      saveTimer(); updateTimerUI();
    }
    // function stopFillAndSubmit(){ pauseTimer(); btnSubmit.click(); }
    function loadTimer(){
      try{
        const t = JSON.parse(localStorage.getItem(TIMER_KEY) || '{}');
        if (typeof t.elapsed === 'number') timer.elapsed = t.elapsed;
        if (t.running && t.startAt) { timer.running = true; timer.startAt = t.startAt; startTick(); }
        else updateTimerUI();
      }catch(_){ updateTimerUI(); }
    }
    // Buttons + shortcuts
    btnStart.addEventListener('click', startTimer);
    btnPause.addEventListener('click', pauseTimer);
    btnReset.addEventListener('click', resetTimer);
    // btnStopFill.addEventListener('click', stopFillAndSubmit);
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        timer.running ? pauseTimer() : startTimer();
      }
    });
    loadTimer();

    // ======== Submit entry (HH:MM:SS → minutes) ========
    btnSubmit.addEventListener('click', async () => {
      const raw = (elName.value || '').trim();
      // exact or unique case-insensitive match
      let name = raw;
      if (!state.nameSet.has(name)) {
        const cand = state.names.filter(n => n.toLowerCase() === raw.toLowerCase());
        if (cand.length === 1) name = cand[0];
      }
      if (!state.nameSet.has(name)) { showStatus('الاسم غير موجود في القائمة. اختر من الاقتراحات.', false); return; }

      const h = Number(durH.value)||0, m = Number(durM.value)||0, s = Number(durS.value)||0;
      const date = elDate.value;
      const minutes = +(h*60 + m + s/60).toFixed(2);
      if (minutes <= 0 || !isFinite(minutes) || !date || m<0 || m>59 || s<0 || s>59 || h<0) {
        showStatus('تحقَّق من المدخلات', false); return;
      }

      btnSubmit.disabled = true; showStatus('جاري الحفظ…');
      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ name, minutes, date })
        });
        const ct = res.headers.get('content-type') || '';
        const j = ct.includes('application/json') ? await res.json() : JSON.parse(await res.text());
        if (j.ok) {
          showStatus('تم الحفظ');
          durH.value=''; durM.value=''; durS.value='';
          resetTimer(); // clear the timer after successful save
        } else {
          showStatus(j.error || 'حدث خطأ', false);
        }
      } catch (e) {
        showStatus(String(e.message || e), false);
      } finally {
        btnSubmit.disabled = false;
      }
    });

    // ======== Dashboard ========
    let chartMain, chartHistory;
    async function loadDashboard(){
      const d = elStatsDate.value || todayISO();
      const range = elRangeSel.value;
      const weekType = elWeekTypeSel.value;

      const [agg, streaks] = await Promise.all([
        fetchJSON(`${API_BASE}?action=stats&range=${range}&date=${d}&weekType=${weekType}`),
        fetchJSON(`${API_BASE}?action=streaks&date=${d}&threshold=1`)
      ]);

      const allRows = (agg && agg.data) ? agg.data : [];
      kpiTotal.textContent = sumMinutes(allRows);
      kpiCount.textContent = allRows.length;
      kpiAvg.textContent   = allRows.length ? Math.round(sumMinutes(allRows)/allRows.length) : 0;

      const topNVal = elTopN.value;
      let rows = allRows.slice(0);
      if (topNVal !== 'All') rows = rows.slice(0, Number(topNVal));
      chartMain = makeBar(chartMainCanvas, rows.map(x=>x.name), rows.map(x=>x.minutes), 'Total');

      // Streaks table (hide zero-streak users)
      tblStreaksBody.innerHTML = '';
      const streakRows = (streaks && streaks.streaks) ? streaks.streaks : [];
      const filtered = streakRows.filter(s => (s.current || 0) > 0 || (s.longest || 0) > 0);
      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="muted" colspan="3">لا يوجد سلاسل</td>`;
        tblStreaksBody.appendChild(tr);
      } else {
        for (const s of filtered) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.name}</td><td>${s.current}</td><td>${s.longest}</td>`;
          tblStreaksBody.appendChild(tr);
        }
      }
    }
    elRefresh.addEventListener('click', loadDashboard);
    elTopN.addEventListener('change', loadDashboard);
    elRangeSel.addEventListener('change', loadDashboard);
    elWeekTypeSel.addEventListener('change', loadDashboard);
    q('#tab-stats').addEventListener('click', () => { if (!chartMainCanvas.__chart) loadDashboard(); });

    // ======== Reader history ========
    function normalizeName(raw){
      const r = (raw || '').trim();
      if (state.nameSet.has(r)) return r;
      const cand = state.names.filter(n => n.toLowerCase() === r.toLowerCase());
      return cand.length === 1 ? cand[0] : null;
    }
    async function loadReaderHistory(){
      const nameRaw = elReaderSel.value;
      const name = normalizeName(nameRaw);
      if (!name) { alert('الاسم غير موجود في القائمة. اختر من الاقتراحات.'); return; }
      const days = elDaysSel.value;
      const d = elReaderDate.value || todayISO();
      const res = await fetchJSON(`${API_BASE}?action=history&name=${encodeURIComponent(name)}&days=${days}&date=${d}`);
      const pts = (res && res.points) ? res.points : [];
      chartHistory = makeLine(chartHistoryCanvas, pts.map(p=>p.date), pts.map(p=>p.minutes), 'Minutes');
    }
    elReaderBtn.addEventListener('click', loadReaderHistory);
    q('#tab-reader').addEventListener('click', () => { if (!chartHistoryCanvas.__chart) loadReaderHistory(); });

    // ======== Discipline ========
    async function loadDiscipline(){
      const d = discDate.value || todayISO();
      const res = await fetchJSON(`${API_BASE}?action=discipline&date=${d}`);
      tblWarnBody.innerHTML = ''; tblRemovedBody.innerHTML = '';
      (res.warning || []).forEach(r => {
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.name}</td><td>${r.minutes}</td>`; tblWarnBody.appendChild(tr);
      });
      (res.removed || []).forEach(r => {
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.name}</td><td>${r.minutes}</td>`; tblRemovedBody.appendChild(tr);
      });
    }
    discBtn.addEventListener('click', loadDiscipline);
    q('#tab-discipline').addEventListener('click', () => { if (!tblWarnBody.childElementCount) loadDiscipline(); });
  </script>
</body>
</html>
