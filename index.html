<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تحدي القراء</title>

  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="logo2.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="mask-icon" href="logo.svg" color="#ff8f00">
  <meta name="theme-color" content="#111826">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    input[list]{ width:100% }
    input[type="date"]{ color-scheme:dark }
    input[type="month"]{ color-scheme:dark }
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="month"]::-webkit-calendar-picker-indicator{ filter:invert(1) brightness(1.8); opacity:1 }
    .date-wrap{ position:relative; display:inline-block }
    .date-wrap input[type="date"], .date-wrap input[type="month"]{ padding-inline-end:2.2rem }
    .date-wrap input[type="date"]::-webkit-calendar-picker-indicator,
    .date-wrap input[type="month"]::-webkit-calendar-picker-indicator{ opacity:0 }
    .date-wrap .cal-ic{ position:absolute; inset-inline-end:.6rem; inset-block-start:50%; transform:translateY(-50%); width:18px; height:18px; pointer-events:none;
      background:no-repeat center/contain url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M7 2h2v2h6V2h2v2h3v18H4V4h3V2zm12 6H5v12h14V8zM7 10h2v2H7v-2zm4 0h2v2h-2v-2zm4 0h2v2h-2v-2zM7 14h2v2H7v-2zm4 0h2v2h-2v-2z"/></svg>') }

    :root{
      --brand-dark:#111826; --brand-accent:#ffb100; --brand-accent-2:#ffc54d;
      --ink:#fff; --ink-dim:#e9e9e9; --ink-muted:#c9c9c9;
      --card:#1a2533; --card-2:#243146; --ring:#40516c; --ok:#22c55e;
      --bg1:#0e1622; --bg2:#111826;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:'Almarai',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif; background:linear-gradient(180deg,var(--bg1),var(--bg2) 60%,var(--bg1)); color:var(--ink) }
    select,input,button{ border-radius:12px; border:1px solid var(--ring); background:var(--card); color:var(--ink); padding:10px 12px; outline:none; font-family:inherit }
    button{ border-color:transparent; background:linear-gradient(180deg,var(--brand-accent),var(--brand-accent-2)); color:#111; font-weight:800; cursor:pointer }
    #timerDisplay,.kpi .v,table td{ font-variant-numeric:tabular-nums }

    header{ max-width:1100px; margin:24px auto 0; padding:0 16px; display:flex; align-items:center; justify-content:space-between; gap:12px }
    header .brand{ display:flex; align-items:center; gap:12px; font-weight:800 }
    header img.logo{ height:36px; width:auto; display:block }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .wrap{ max-width:1100px; margin:16px auto 40px; padding:0 16px }
    .tabs{ display:flex; gap:8px; margin-bottom:16px }
    .tab{ padding:10px 16px; background:var(--card); border:1px solid var(--ring); border-radius:12px; cursor:pointer; user-select:none }
    .tab.active{ background:var(--card-2); border-color:var(--brand-accent-2); box-shadow:0 0 0 2px rgba(255,177,0,.25) inset }
    .card{ background:rgba(17,24,38,.65); backdrop-filter:blur(6px); border:1px solid var(--ring); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25) }
    .row{ display:grid; grid-template-columns:repeat(4,1fr); gap:16px }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:16px }
    .row-2{ display:grid; grid-template-columns:repeat(2,1fr); gap:16px; align-items:start }
    @media (max-width:980px){ .row{ grid-template-columns:repeat(2,1fr) } .row-2{ grid-template-columns:1fr } }
    @media (max-width:640px){ .row,.row-3{ grid-template-columns:1fr } header{ flex-direction:column; align-items:flex-start; gap:8px } }
    label{ display:block; font-size:14px; color:var(--ink-dim); margin-bottom:6px }
    .muted{ color:var(--ink-muted); font-size:13px }
    .spacer{ height:16px }
    .hidden{ display:none }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid var(--ring); font-size:12px }
    .kpi{ text-align:center; background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px }
    .kpi .v{ font-size:28px; font-weight:800; color:var(--brand-accent-2) }
    footer{ text-align:center; margin-top:20px; color:var(--ink-muted); font-size:12px }

    /* HH:MM:SS */
    .timegrid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px }
    .timegrid input{ width:100%; min-width:0; text-align:center; direction:ltr }
    .timegrid input::-webkit-outer-spin-button,.timegrid input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    .timegrid input[type="number"]{ -moz-appearance:textfield }

    /* Single timer button */
    .timer{ display:flex; flex-direction:column; gap:10px; margin-top:10px; align-items:center }
    #timerDisplay{ text-align:center; direction:ltr; font-size:28px; font-weight:800; letter-spacing:1.5px;
      padding:10px 12px; border:1px solid var(--ring); background:var(--card); border-radius:12px; width:240px }
    .timer .toggle{ --size:56px; width:var(--size); height:var(--size); border-radius:999px; display:grid; place-items:center;
      border:1px solid var(--ring); background:linear-gradient(180deg,var(--brand-accent),var(--brand-accent-2));
      box-shadow:0 2px 8px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06); cursor:pointer }
    .timer .toggle svg{ width:26px; height:26px; fill:#111 }
    .timer .hint{ font-size:12px; color:var(--ink-muted) }

    /* Segments */
    .seg-grid{ display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:12px; margin-top:8px }
    @media (max-width:1100px){ .seg-grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    @media (max-width:700px){ .seg-grid{ grid-template-columns:repeat(1,minmax(0,1fr)) } }
    .seg-card{ background:var(--card); border:1px solid var(--ring); border-radius:12px; padding:12px }
    .seg-head{ font-weight:700; color:var(--ink-dim); margin-bottom:8px; display:flex; gap:8px; align-items:baseline }
    .seg-head small{ color:var(--ink-muted); font-weight:400 }
    .seg-names{ display:flex; flex-wrap:wrap; gap:6px }
    .chip{ display:inline-block; padding:4px 8px; border:1px solid var(--ring); border-radius:999px; background:rgba(255,255,255,.04); font-size:12px; cursor:pointer }
    .chip:hover{ border-color:var(--brand-accent-2) }

    /* Badges */
    .badges{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:14px; margin:6px 0 18px }
    @media (max-width:980px){ .badges{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
    @media (max-width:640px){ .badges{ grid-template-columns:1fr } }
    .badge{ position:relative; padding:14px 16px; border-radius:14px; background:var(--card); border:1px solid var(--ring);
      box-shadow:0 8px 22px rgba(0,0,0,.25); display:flex; align-items:center; gap:12px }
    .badge .ic{ width:44px; height:44px; flex:0 0 44px; border-radius:12px; display:grid; place-items:center;
      background:linear-gradient(180deg,var(--brand-accent),var(--brand-accent-2)); color:#111; font-size:22px; font-weight:800 }
    .badge .txt .title{ font-weight:800 }
    .badge .txt .name{ font-weight:800; color:var(--brand-accent-2) }
    .streak-strip{ display:grid; grid-template-columns:repeat(30,1fr); gap:2px; margin-top:6px }
    .streak-strip span{ display:block; height:8px; border-radius:3px; background:#2c3a52 }
    .streak-strip span.on{ background:#22c55e }

    /* Reader month calendar */
    .cal{ border:1px solid var(--ring); border-radius:12px; padding:12px }
    .cal .cal-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; font-weight:800 }
    .cal .grid{ display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:6px }
    .cal .dow{ text-align:center; font-size:12px; color:var(--ink-muted) }
    .cal .cell{ position:relative; min-height:52px; border:1px dashed rgba(255,255,255,.06); border-radius:10px; padding:6px; }
    .cal .cell .d{ position:absolute; top:6px; inset-inline-start:8px; font-weight:700; opacity:.85 }
    .cal .cell.hit{ border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.06) }
    .cal .dot{ position:absolute; bottom:8px; inset-inline-start:50%; transform:translateX(-50%); width:8px; height:8px; border-radius:99px; background:#22c55e }
    .legend{ display:none } /* حذف الراحة/لم يقرأ */

    body.rtl{ direction:rtl } body.rtl .row,body.rtl .row-3{ direction:rtl }
  </style>

  <script>
    // ضبط ألوان تشارت لوضوح أعلى
    Chart.defaults.color = '#e9e9e9';
    Chart.defaults.borderColor = 'rgba(233,233,233,0.15)';
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(17,24,38,0.95)';
    Chart.defaults.plugins.tooltip.titleColor = '#fff';
    Chart.defaults.plugins.tooltip.bodyColor = '#fff';
  </script>
</head>
<body class="rtl">
  <header>
    <div class="brand"><img class="logo" id="logo" alt="Logo" /><div id="appTitle">تحدي القراء</div></div>
    <div class="controls">
      <select id="langSel" title="اللغة"><option value="ar" selected>العربية</option><option value="en">English</option></select>
      <select id="weekTypeSel" title="نمط الأسبوع"><option value="rolling">٧ أيام متحركة</option><option value="calendar">أسبوع تقويمي (السبت–الجمعة)</option></select>
    </div>
  </header>

  <div class="wrap">
    <div class="tabs" role="tablist" aria-label="Pages">
      <div class="tab active" data-tab="log" role="tab" aria-selected="true" tabindex="0" id="tab-log">تسجيل القراءة</div>
      <div class="tab" data-tab="stats" role="tab" aria-selected="false" tabindex="0" id="tab-stats">لوحة الإحصائيات</div>
      <div class="tab" data-tab="reader" role="tab" aria-selected="false" tabindex="0" id="tab-reader">سجل القارئ</div>
      <div class="tab" data-tab="discipline" role="tab" aria-selected="false" tabindex="0" id="tab-discipline">المطرودون/الإنذارات</div>
    </div>

    <!-- Log Form -->
    <div id="panel-log" class="card" role="tabpanel" aria-labelledby="tab-log">
      <h2 id="logTitle" style="margin-top:0">إضافة جلسة قراءة</h2>
      <div class="row">
        <div>
          <label for="name" id="lblReader">القارئ</label>
          <input id="name" list="namesList" autocomplete="off" placeholder="اسمك…" />
          <datalist id="namesList"></datalist>
          <div class="muted" id="nameHint">لم تجد اسمك؟ تواصل مع المجلس الأعلى</div>
        </div>

        <div>
          <label id="lblDuration">المدة (ث:د:س)</label>
          <div class="timegrid">
            <input id="durS" type="number" min="0" max="59" step="1" placeholder="ث" inputmode="numeric" />
            <input id="durM" type="number" min="0" max="59" step="1" placeholder="د" inputmode="numeric" />
            <input id="durH" type="number" min="0" step="1" placeholder="س" inputmode="numeric" />
          </div>
          <div class="timer">
            <div id="timerDisplay">00:00:00</div>
            <button id="btnToggle" class="toggle" type="button" aria-label="تشغيل/إيقاف مؤقت" title="تشغيل/إيقاف">
              <svg id="icoToggle" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <div class="hint">لمس مطوّل للتصفير</div>
          </div>
          <div class="muted" id="durationHint">أدخل الساعات والدقائق والثواني</div>
        </div>

        <div>
          <label for="date" id="lblDate">التاريخ</label>
          <div class="date-wrap"><input id="date" type="date" /><span class="cal-ic" aria-hidden="true"></span></div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="submitBtn">حفظ</button>
          <span class="muted" id="status" role="status" aria-live="polite"></span>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div id="panel-stats" class="card hidden" role="tabpanel" aria-labelledby="tab-stats">
      <h2 id="dashTitle" style="margin-top:0">لوحة الإحصائيات</h2>

      <!-- Badges -->
      <div class="badge-row">
        <div style="display:flex; justify-content:flex-end; margin-bottom:6px;"><span class="pill">جوائز الفترة</span></div>
        <div id="badges" class="badges"></div>
      </div>

      <div class="row">
        <div>
          <label for="statsDate" id="lblRefDate">تاريخ المرجع</label>
          <div class="date-wrap"><input id="statsDate" type="date" /><span class="cal-ic" aria-hidden="true"></span></div>
        </div>
        <div>
          <label for="rangeSel" id="lblRange">المدى</label>
          <select id="rangeSel"><option value="day">اليوم</option><option value="week">الأسبوع</option><option value="month">الشهر</option><option value="all">كل الوقت</option></select>
        </div>
        <div>
          <label for="topNSel" id="lblTopN" class="muted" style="display:block;">أفضل N</label>
          <select id="topNSel"><option>10</option><option selected>20</option><option>50</option><option>100</option><option>All</option></select>
        </div>
        <div>
          <label for="segSel" id="lblSeg" class="muted" style="display:block;">التصنيف</label>
          <select id="segSel"><option value="all" selected>الكل</option><option value="steady">مستقرون</option><option value="sprinter">اندفاعيون</option><option value="weekend">تركيز نهاية الأسبوع</option><option value="mixed">متنوع</option><option value="inactive">غير نشط</option></select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="refreshBtn">تحديث</button>
          <span class="muted" id="rangeHint">اليوم = نفس التاريخ · الأسبوع = ٧ أيام متحركة أو أسبوع تقويمي (السبت–الجمعة) · الشهر = شهر تقويمي</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row-3" id="kpiRow">
        <div class="kpi"><div class="v" id="kpi-total">–</div><div class="muted" id="kpiTotalLabel">إجمالي الدقائق</div></div>
        <div class="kpi"><div class="v" id="kpi-avg">–</div><div class="muted" id="kpiAvgLabel">متوسط لكل قارئ</div></div>
        <div class="kpi"><div class="v" id="kpi-count">–</div><div class="muted" id="kpiCountLabel">عدد القرّاء النشطين</div></div>
      </div>

      <div class="spacer"></div>

      <div class="card" style="background:transparent; border:0; padding:0;">
        <div style="display:grid; grid-template-columns:1fr; gap:24px;">
          <div><div class="pill" id="pillByReader">حسب القارئ</div><canvas id="chartMain" height="140"></canvas></div>
          <div>
            <div class="pill" id="pillSegments">تصنيفات القرّاء (آخر ١٢ أسبوع)</div>
            <div id="segCounts" class="muted">—</div>
            <div id="segGrid" class="seg-grid"></div>
          </div>
          <div><div class="pill" id="pillDOW">قوة أيام الأسبوع (متوسط آخر ١٢ أسبوع)</div><canvas id="chartDOW" height="100"></canvas></div>
          <div>
            <div class="pill" id="pillStreaks">سلاسل الأيام المتتالية (≥ دقيقة يومياً)</div>
            <table id="tblStreaks"><thead><tr><th id="thReader">القارئ</th><th id="thCurrent">الحالية</th><th id="thLongest">الأطول</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>

    <!-- Reader History (Month Calendar) -->
    <div id="panel-reader" class="card hidden" role="tabpanel" aria-labelledby="tab-reader">
      <h2 id="readerTitle" style="margin-top:0">سجل القارئ (تقويم شهري)</h2>
      <div class="row">
        <div>
          <label for="readerSel" id="lblReaderSel">القارئ</label>
          <input id="readerSel" list="readerList" autocomplete="off" placeholder="ابحث عن قارئ…" />
          <datalist id="readerList"></datalist>
        </div>
        <div>
          <label for="readerMonth" id="lblReaderMonth">الشهر</label>
          <div class="date-wrap">
            <input id="readerMonth" type="month" />
            <span class="cal-ic" aria-hidden="true"></span>
          </div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px;">
          <button id="readerBtn">عرض</button>
          <span class="muted" id="readerHint">يعرض أيام القراءة فقط</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div id="readerCal" class="cal">
        <div class="cal-head"><div id="calTitle">—</div></div>
        <div class="grid" id="calGrid"></div>
      </div>

      <div class="spacer"></div>
      <div class="pill" id="pillHistory">الدقائق اليومية (اختياري)</div>
      <canvas id="chartHistory" height="160"></canvas>
    </div>

    <!-- Discipline -->
    <div id="panel-discipline" class="card hidden" role="tabpanel" aria-labelledby="tab-discipline">
      <h2 style="margin-top:0" id="discTitle">المطرودون والإنذارات</h2>
      <div class="row">
        <div><label id="lblDiscDate" for="discDate">تاريخ المرجع</label><div class="date-wrap"><input id="discDate" type="date" /><span class="cal-ic" aria-hidden="true"></span></div></div>
        <div style="display:flex; align-items:flex-end; gap:12px;"><button id="discBtn">تحديث القائمة</button><span class="muted" id="discHint">الأسبوع يبدأ السبت وينتهي الجمعة</span></div>
      </div>
      <div class="spacer"></div>
      <div class="row-2">
        <div><div class="pill" id="pillWarn">قائمة الإنذار (أقل من 30 دقيقة في الأسبوع السابق)</div>
          <table id="tblWarn"><thead><tr><th>القارئ</th><th>دقائق الأسبوع السابق</th></tr></thead><tbody></tbody></table></div>
        <div><div class="pill" id="pillRemoved">قائمة المطرودين (أقل من 60 دقيقة في آخر أسبوعين مكتملين)</div>
          <table id="tblRemoved"><thead><tr><th>القارئ</th><th>مجموع آخر أسبوعين</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

    <footer><span id="footNote">صُنع بحب لتحدي القراء</span></footer>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = 'https://script.google.com/macros/s/AKfycbwu4LmHJU16fyl7jo-ksKO2e-H70H00em6WmhkXMcREKxDcYOrhlJdU8B-YbuF4IvIt/exec';
    const FALLBACK_NAMES = ['Reader 1','Reader 2','Reader 3'];
    const LOGO_SRC = 'logo.svg';

    // ====== DOM ======
    const tabs = document.querySelectorAll('.tab');
    const panels = { log: q('#panel-log'), stats: q('#panel-stats'), reader: q('#panel-reader'), discipline: q('#panel-discipline') };
    const logo = q('#logo');

    const dlNames = document.getElementById('namesList');
    const dlReaders = document.getElementById('readerList');

    const elName = q('#name');
    const elDate = q('#date');
    const elStatus = q('#status');
    const btnSubmit = q('#submitBtn');
    const durH = q('#durH'), durM = q('#durM'), durS = q('#durS');

    const timerDisplay = q('#timerDisplay');
    const btnToggle = q('#btnToggle');
    const icoToggle = q('#icoToggle');

    const elStatsDate = q('#statsDate');
    const elRangeSel = q('#rangeSel');
    const elTopN = q('#topNSel');
    const elRefresh = q('#refreshBtn');
    const elWeekTypeSel = q('#weekTypeSel');
    const elSegSel = q('#segSel');

    const kpiTotal = q('#kpi-total'), kpiAvg = q('#kpi-avg'), kpiCount = q('#kpi-count');

    const chartMainCanvas = q('#chartMain');
    const chartHistoryCanvas = q('#chartHistory');
    const chartDOWCanvas = q('#chartDOW');

    const tblStreaksBody = q('#tblStreaks tbody');
    const tblWarnBody = q('#tblWarn tbody');
    const tblRemovedBody = q('#tblRemoved tbody');

    const discDate = q('#discDate');
    const discBtn = q('#discBtn');

    const langSel = q('#langSel');

    const segCountsDiv = q('#segCounts');
    const segGrid = q('#segGrid');
    const badgesDiv = q('#badges');

    // Reader calendar
    const readerMonth = q('#readerMonth');
    const readerSel = q('#readerSel');
    const calTitle = q('#calTitle');
    const calGrid = q('#calGrid');

    // ====== Helpers ======
    function q(s){ return document.querySelector(s) }
    function todayISO(){ const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}` }
    function monthNow(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` }
    function showStatus(msg, ok=true){ elStatus.textContent=msg; elStatus.style.color= ok?'#8ef5b2':'#ffb4b4' }
    function fetchJSON(url,opts){ return fetch(url,opts).then(r=>r.json()) }
    function sumMinutes(arr){ return arr.reduce((a,b)=>a+(Number(b.minutes)||0),0) }
    function setDirRTL(isRTL){ document.body.classList.toggle('rtl',isRTL); document.documentElement.setAttribute('dir',isRTL?'rtl':'ltr') }
    function esc(s){ return (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

    function makeBar(ctx, labels, data, title){
      if (ctx.__chart) ctx.__chart.destroy();
      const c=new Chart(ctx,{type:'bar',
        data:{labels,datasets:[{label:title,data,backgroundColor:'rgba(255,177,0,0.85)',hoverBackgroundColor:'rgba(255,197,77,0.95)'}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true,ticks:{precision:0}}}}
      }); ctx.__chart=c; return c;
    }
    function makeLine(ctx, labels, data, title){
      if (ctx.__chart) ctx.__chart.destroy();
      const c=new Chart(ctx,{type:'line',
        data:{labels,datasets:[{label:title,data,tension:.35,fill:false,borderWidth:2.5,borderColor:'#ffb100',pointRadius:2.5,pointHoverRadius:4}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true,ticks:{precision:0}}}}
      }); ctx.__chart=c; return c;
    }

    // ====== Init ======
    const state = { lang:'ar', names:[], nameSet:new Set(), segMap:new Map() };
    logo.src = LOGO_SRC;
    const t0 = todayISO();
    elDate.value = t0; elStatsDate.value = t0; q('#discDate').value = t0;
    readerMonth.value = monthNow();
    langSel.addEventListener('change', e=> setDirRTL(e.target.value==='ar'));

    tabs.forEach(tab=>{
      const activate=()=>{ tabs.forEach(x=>{x.classList.remove('active');x.setAttribute('aria-selected','false')});
        tab.classList.add('active'); tab.setAttribute('aria-selected','true');
        const k=tab.dataset.tab; Object.keys(panels).forEach(p=>panels[p].classList.toggle('hidden',p!==k));
        if(k==='stats') loadDashboard(); if(k==='reader'){ loadReaderNames(); renderReaderMonth(); } if(k==='discipline') loadDiscipline();
      };
      tab.addEventListener('click',activate);
      tab.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' ') activate() });
    });

    // Names
    function setNames(list){
      const names=(Array.isArray(list)&&list.length)?list:FALLBACK_NAMES;
      dlNames.innerHTML=''; dlReaders.innerHTML='';
      for(const n of names){ const o1=document.createElement('option');o1.value=n;dlNames.appendChild(o1);
        const o2=document.createElement('option');o2.value=n;dlReaders.appendChild(o2); }
      state.names=names.slice(); state.nameSet=new Set(names.map(x=>x.trim()));
    }
    function loadNames(){ fetchJSON(`${API_BASE}?action=names`).then(j=>setNames(j&&j.ok?j.names:null)).catch(()=>setNames(null)) }
    function loadReaderNames(){ if(dlReaders.childElementCount===0) loadNames() }
    loadNames();

    // ====== Timer (ONE BUTTON) ======
    const TIMER_KEY='readingTimer:v1';
    const timer={ running:false, startAt:0, elapsed:0, rafId:null };
    function saveTimer(){ try{ localStorage.setItem(TIMER_KEY, JSON.stringify({running:timer.running,startAt:timer.startAt,elapsed:timer.elapsed})) }catch(_){ } }
    function msToHMS(ms){ ms=Math.max(0,Math.floor(ms)); const sTot=Math.floor(ms/1000); const h=Math.floor(sTot/3600), m=Math.floor((sTot%3600)/60), s=sTot%60; return {h,m,s,label:`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`} }
    function fillInputsFromElapsed(){ if(!timer.running && timer.elapsed===0) return; const {h,m,s}=msToHMS(timer.elapsed); durH.value=h; durM.value=m; durS.value=s }
    function setIcon(running){ icoToggle.innerHTML = running ? '<path d="M6 5h4v14H6zM14 5h4v14h-4z"/>' : '<path d="M8 5v14l11-7z"/>' }
    function updateTimerUI(){ const t=msToHMS(timer.elapsed); timerDisplay.textContent=t.label; fillInputsFromElapsed(); setIcon(timer.running) }
    function tick(){ if(!timer.running) return; timer.elapsed=Date.now()-timer.startAt; updateTimerUI(); timer.rafId=requestAnimationFrame(tick) }
    function startTick(){ cancelAnimationFrame(timer.rafId); timer.rafId=requestAnimationFrame(tick) }
    function startTimer(){ if(timer.running) return; timer.running=true; timer.startAt=Date.now()-timer.elapsed; saveTimer(); updateTimerUI(); startTick() }
    function pauseTimer(){ if(!timer.running) return; timer.running=false; cancelAnimationFrame(timer.rafId); timer.elapsed=Date.now()-timer.startAt; saveTimer(); updateTimerUI() }
    function resetTimer(){ timer.running=false; cancelAnimationFrame(timer.rafId); timer.elapsed=0; durH.value=''; durM.value=''; durS.value=''; saveTimer(); updateTimerUI() }
    function loadTimer(){ try{ const t=JSON.parse(localStorage.getItem(TIMER_KEY)||'{}'); if(typeof t.elapsed==='number') timer.elapsed=t.elapsed; if(t.running && t.startAt){ timer.running=true; timer.startAt=t.startAt; startTick() } else updateTimerUI() }catch(_){ updateTimerUI() } }
    let pressTimer=null;
    btnToggle.addEventListener('click', ()=>{ timer.running?pauseTimer():startTimer() });
    btnToggle.addEventListener('pointerdown', ()=>{ clearTimeout(pressTimer); pressTimer=setTimeout(()=>resetTimer(),800) });
    btnToggle.addEventListener('pointerup', ()=> clearTimeout(pressTimer));
    btnToggle.addEventListener('pointerleave', ()=> clearTimeout(pressTimer));
    document.addEventListener('keydown', e=>{
      if(e.code==='Space' && document.activeElement.tagName!=='INPUT'){ e.preventDefault(); timer.running?pauseTimer():startTimer() }
      if(e.code==='KeyR' && (e.metaKey||e.ctrlKey)) { e.preventDefault(); resetTimer() }
    });
    loadTimer();

    // ====== Submit ======
    btnSubmit.addEventListener('click', async ()=>{
      const raw=(elName.value||'').trim(); let name=raw;
      if(!state.nameSet.has(name)){ const cand=state.names.filter(n=>n.toLowerCase()===raw.toLowerCase()); if(cand.length===1) name=cand[0]; }
      if(!state.nameSet.has(name)){ showStatus('الاسم غير موجود في القائمة. اختر من الاقتراحات.', false); return }

      const h=Number(durH.value)||0, m=Number(durM.value)||0, s=Number(durS.value)||0;
      const date=elDate.value; const minutes=+(h*60+m+s/60).toFixed(2);
      if(minutes<=0 || !isFinite(minutes) || !date || m<0 || m>59 || s<0 || s>59 || h<0){ showStatus('تحقَّق من المدخلات', false); return }

      btnSubmit.disabled=true; showStatus('جاري الحفظ…');
      try{
        const res=await fetch(API_BASE,{ method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify({name,minutes,date}) });
        const ct=res.headers.get('content-type')||''; const j=ct.includes('application/json')?await res.json():JSON.parse(await res.text());
        if(j.ok){ showStatus('تم الحفظ'); durH.value=''; durM.value=''; durS.value=''; resetTimer() } else { showStatus(j.error||'حدث خطأ', false) }
      }catch(e){ showStatus(String(e.message||e), false) } finally{ btnSubmit.disabled=false }
    });

    // ====== Dashboard + Badges (كما في النسخة السابقة) ======
    let chartMain, chartHistory, chartDOW;

    function mapTotalsByName(statsObj){ const map=new Map(); const rows=(statsObj&&statsObj.data)?statsObj.data:[]; rows.forEach(r=>map.set(r.name, Number(r.minutes)||0)); return map }
    function getPrevDate(range, dateStr){ const d=new Date((dateStr||todayISO())+'T00:00:00'); if(range==='day') d.setDate(d.getDate()-1); else if(range==='week') d.setDate(d.getDate()-7); else if(range==='month') d.setMonth(d.getMonth()-1); return d.toISOString().slice(0,10) }
    function renderStreakStrip(days=30, hitDaysSet=new Set()){
      const frag=document.createDocumentFragment();
      for(let i=days-1;i>=0;i--){ const span=document.createElement('span'); const dd=new Date(Date.now()-i*86400000);
        const key=`${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,'0')}-${String(dd.getDate()).padStart(2,'0')}`;
        if(hitDaysSet.has(key)) span.className='on';
        frag.appendChild(span);
      }
      const wrap=document.createElement('div'); wrap.className='streak-strip'; wrap.appendChild(frag); return wrap.outerHTML;
    }
    function renderBadges({range, aggNow, aggPrev, streaks, byReader30}){
      const nowMap=mapTotalsByName(aggNow), prevMap=mapTotalsByName(aggPrev);
      let bestName='—', bestVal=0; nowMap.forEach((v,k)=>{ if(v>bestVal){bestVal=v; bestName=k} });
      let impName='—', impVal=-Infinity; nowMap.forEach((v,k)=>{ const prev=prevMap.get(k)||0; const diff=v-prev; if(diff>impVal){impVal=diff; impName=k} }); if(!isFinite(impVal)) impVal=0;
      let wkndName='—', wkndVal=0;
      Object.keys(byReader30||{}).forEach(n=>{ const v=(byReader30[n].fri||0)+(byReader30[n].sat||0); if(v>wkndVal){ wkndVal=v; wkndName=n } });

      let bestStreakName='—', bestStreakLen=0, currentStreak=0, stripHTML='';
      if(streaks && Array.isArray(streaks.streaks)){
        streaks.streaks.forEach(s=>{ if((s.longest||0)>bestStreakLen){ bestStreakLen=s.longest||0; bestStreakName=s.name; currentStreak=s.current||0 } });
        const daysSet=new Set(((byReader30[bestStreakName]||{}).days||[])); stripHTML=renderStreakStrip(30, daysSet);
      }
      const fmt=v=>`${Math.round(Math.max(0,Number(v)||0))} دقيقة`;
      const card=(icon,title,name,sub)=>`<div class="badge"><div class="ic">${icon}</div><div class="txt"><div class="title">${title}</div><div class="name">${esc(name||'—')}</div><small>${sub||''}</small></div></div>`;
      badgesDiv.innerHTML =
        card('🏅','قارئ الفترة',bestName,fmt(bestVal)) +
        card('📈','الأفضل تحسّنًا',impName,`+${fmt(impVal)}`) +
        card('🎉','بطل نهاية الأسبوع',wkndName,fmt(wkndVal)) +
        `<div class="badge"><div class="ic">🔥</div><div class="txt"><div class="title">أطول سلسلة نشطة</div>
          <div class="name">${esc(bestStreakName||'—')}</div><small>الحالية ${currentStreak||0} · الأطول ${bestStreakLen||0} يوم</small>${stripHTML}</div></div>`;
    }

    async function loadDashboard(){
      const d=elStatsDate.value||todayISO();
      const range=elRangeSel.value, weekType=elWeekTypeSel.value;
      const prevDate=getPrevDate(range,d);

      const [agg, aggPrev, streaks, segRes, dowRes] = await Promise.all([
        fetchJSON(`${API_BASE}?action=stats&range=${range}&date=${d}&weekType=${weekType}`),
        fetchJSON(`${API_BASE}?action=stats&range=${range}&date=${prevDate}&weekType=${weekType}`),
        fetchJSON(`${API_BASE}?action=streaks&date=${d}&threshold=1`),
        fetchJSON(`${API_BASE}?action=segments&date=${d}&weeks=12`),
        fetchJSON(`${API_BASE}?action=dow&date=${d}&weeks=12`)
      ]).catch(()=>[null,null,null,null,null]);

      // KPIs
      const allRows=(agg&&agg.data)?agg.data:[]; const total=sumMinutes(allRows); const activeCount=allRows.length;
      kpiTotal.textContent=total; kpiCount.textContent=activeCount; kpiAvg.textContent= activeCount ? Math.round(total/activeCount) : 0;

      // build 30-day map per reader (للبطل الأسبوعي وشريط السلسلة)
      const byReader30={};
      try{
        const names=new Set(allRows.map(r=>r.name));
        const promises=[...names].slice(0,120).map(n=>fetchJSON(`${API_BASE}?action=history&name=${encodeURIComponent(n)}&days=30&date=${d}`).then(j=>{
          const days=(j.points||[]).filter(p=>(Number(p.minutes)||0)>0).map(p=>p.date);
          let fri=0,sat=0; (j.points||[]).forEach(p=>{ const dd=new Date(p.date+'T00:00:00'); const mm=Math.max(0,Number(p.minutes)||0); if(dd.getDay()===5) fri+=mm; if(dd.getDay()===6) sat+=mm; });
          byReader30[n]={days,fri,sat};
        }));
        await Promise.all(promises);
      }catch(_){}

      // Badges
      renderBadges({range, aggNow:agg, aggPrev, streaks, byReader30});

      // Segments
      state.segMap=new Map(); segGrid.innerHTML='';
      if(segRes && segRes.ok){
        (segRes.segments||[]).forEach(s=>state.segMap.set(s.name,s.segment));
        const s=segRes.summary||{steady:0,sprinter:0,weekend:0,mixed:0,inactive:0};
        segCountsDiv.textContent=`مستقرون: ${s.steady} · اندفاعيون: ${s.sprinter} · نهاية الأسبوع: ${s.weekend} · متنوع: ${s.mixed} · غير نشط: ${s.inactive}`;
        const labels={steady:'مستقرون',sprinter:'اندفاعيون',weekend:'نهاية الأسبوع',mixed:'متنوع',inactive:'غير نشط'};
        const groups={steady:[],sprinter:[],weekend:[],mixed:[],inactive:[]};
        (segRes.segments||[]).forEach(r=>{ if(groups[r.segment]) groups[r.segment].push(r.name) });
        const sections=Object.keys(groups).map(key=>{
          const names=groups[key].sort((a,b)=>a.localeCompare(b,'ar'));
          const chips=names.map(n=>`<span class="chip" data-name="${esc(n)}" data-seg="${key}">${esc(n)}</span>`).join('')||`<span class="muted">—</span>`;
          return `<div class="seg-card"><div class="seg-head">${labels[key]} <small>(${names.length})</small></div><div class="seg-names">${chips}</div></div>`;
        }).join('');
        segGrid.innerHTML=sections;
      } else segCountsDiv.textContent='لا توجد بيانات للتصنيف.';

      // Top N + main chart
      const selectedSeg=elSegSel.value; let rows=(agg&&agg.data)?agg.data.slice(0):[];
      if(selectedSeg!=='all'){ rows=rows.filter(x=>(state.segMap.get(x.name)||'mixed')===selectedSeg) }
      const topNVal=elTopN.value; if(topNVal!=='All') rows=rows.slice(0,Number(topNVal));
      makeBar(chartMainCanvas, rows.map(x=>x.name), rows.map(x=>Math.round(Number(x.minutes)||0)), 'Total');

      // DOW
      if(dowRes && dowRes.ok){ const items=dowRes.items||[]; makeBar(chartDOWCanvas, items.map(i=>i.label), items.map(i=>Math.round(Number(i.avg)||0)), 'DOW') }

      // Streaks table
      tblStreaksBody.innerHTML='';
      const streakRows=(await (async()=>agg && await fetchJSON(`${API_BASE}?action=streaks&date=${elStatsDate.value||todayISO()}&threshold=1`)))?.streaks || [];
      const filtered=streakRows.map(s=>({ ...s, current:Number(s.current)||0, longest:Number(s.longest)||0 }))
        .filter(s=>s.current>0 || s.longest>0).sort((a,b)=> b.current-b.current || b.longest-a.longest);
      if(filtered.length===0){ const tr=document.createElement('tr'); tr.innerHTML=`<td class="muted" colspan="3">لا يوجد سلاسل</td>`; tblStreaksBody.appendChild(tr) }
      else{ for(const s of filtered){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(s.name)}</td><td>${s.current}</td><td>${s.longest}</td>`; tblStreaksBody.appendChild(tr) } }
    }

    elRefresh.addEventListener('click', loadDashboard);
    elTopN.addEventListener('change', loadDashboard);
    elRangeSel.addEventListener('change', loadDashboard);
    elWeekTypeSel.addEventListener('change', loadDashboard);
    elSegSel.addEventListener('change', loadDashboard);
    q('#tab-stats').addEventListener('click', ()=>{ if(!chartMainCanvas.__chart) loadDashboard() });
    segGrid.addEventListener('click', e=>{
      const chip=e.target.closest('.chip'); if(!chip) return; const name=chip.dataset.name;
      q('#tab-reader').click(); readerSel.value=name; setTimeout(()=>renderReaderMonth(),50);
    });

    // ====== Reader Month Calendar ======
    function normalizeName(raw){
      const r=(raw||'').trim();
      if(state.nameSet.has(r)) return r;
      const cand=state.names.filter(n=>n.toLowerCase()===r.toLowerCase());
      return cand.length===1?cand[0]:null;
    }
    function monthFirstLast(valYYYYMM){
      const [y,m]=valYYYYMM.split('-').map(Number);
      const first=new Date(y,m-1,1);
      const last=new Date(y,m,0);
      return {first,last,days:last.getDate()};
    }
    function arMonthName(date){
      const fmt=new Intl.DateTimeFormat('ar', {month:'long', year:'numeric'});
      return fmt.format(date);
    }
    function buildCalendarSkeleton(first){
      const dow=['أحد','إثنين','ثلاثاء','أربعاء','خميس','جمعة','سبت'];
      const header = dow.map(d=>`<div class="dow">${d}</div>`).join('');
      // leading blanks
      const blanks=(first.getDay()+1)%7; // لضبط RTL (نبدأ بالأحد)
      return { header, blanks };
    }
    function renderCalendarGrid(monthVal, points){
      const {first,last,days}=monthFirstLast(monthVal);
      calTitle.textContent = arMonthName(first);
      const map=new Map(points.filter(p=>(Number(p.minutes)||0)>0).map(p=>[p.date, Math.round(Number(p.minutes)||0)]));
      const {header,blanks}=buildCalendarSkeleton(first);
      const cells=[];
      // 7 DOW header
      calGrid.innerHTML=''; calGrid.insertAdjacentHTML('beforeend', header);
      // blanks before first day
      for(let i=0;i<blanks;i++) calGrid.insertAdjacentHTML('beforeend','<div class="cell"></div>');
      for(let d=1; d<=days; d++){
        const key=`${first.getFullYear()}-${String(first.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const has=map.has(key);
        const minutes=map.get(key)||0;
        const cell = `<div class="cell ${has?'hit':''}"><div class="d">${d}</div>${has?'<span class="dot"></span>':''}${has?`<div class="muted" style="position:absolute;bottom:8px;inset-inline-end:8px;font-size:11px;">${minutes}</div>`:''}</div>`;
        cells.push(cell);
      }
      calGrid.insertAdjacentHTML('beforeend', cells.join(''));
    }

    async function renderReaderMonth(){
      const name=normalizeName(readerSel.value);
      if(!name){ calTitle.textContent='اختر قارئًا'; calGrid.innerHTML=''; return; }
      const monthVal = readerMonth.value || monthNow();
      const {first,last,days} = monthFirstLast(monthVal);
      // نستخدم endpoint history بنطاق أيام الشهر عبر date=آخر يوم و days=عدد أيام الشهر
      const res = await fetchJSON(`${API_BASE}?action=history&name=${encodeURIComponent(name)}&days=${days}&date=${last.toISOString().slice(0,10)}`);
      const pts=(res&&res.points)?res.points:[];
      renderCalendarGrid(monthVal, pts);
      // رسم خطّي اختياري لنفس الشهر
      makeLine(chartHistoryCanvas, pts.map(p=>p.date), pts.map(p=>p.minutes), 'Minutes');
    }

    q('#readerBtn').addEventListener('click', renderReaderMonth);
    readerMonth.addEventListener('change', renderReaderMonth);
    q('#tab-reader').addEventListener('click', ()=>{ if(!chartHistoryCanvas.__chart) renderReaderMonth(); });

    // ====== Discipline ======
    async function loadDiscipline(){
      const d=discDate.value||todayISO(); const res=await fetchJSON(`${API_BASE}?action=discipline&date=${d}`);
      tblWarnBody.innerHTML=''; tblRemovedBody.innerHTML='';
      (res.warning||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.name}</td><td>${r.minutes}</td>`; tblWarnBody.appendChild(tr) });
      (res.removed||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.name}</td><td>${r.minutes}</td>`; tblRemovedBody.appendChild(tr) });
    }
    discBtn.addEventListener('click', loadDiscipline);
    q('#tab-discipline').addEventListener('click', ()=>{ if(!tblWarnBody.childElementCount) loadDiscipline() });
  </script>
</body>
</html>
